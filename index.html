<!doctype html>
<html>
  <head>
    <meta charset='UTF-8' />
    <!-- need to invesitgate the use of the viewport option, it doesn't appear to be working, see
         http://developer.android.com/guide/webapps/targeting.html
         http://developer.android.com/guide/webapps/best-practices.html
         
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0' />
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

    <title>Videre</title>
    
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type='text/javascript' src='assets/js/jquery-1.8.0.min.js'></script>
    <script type='text/javascript' src='assets/js/jquery-ui-1.8.23.custom.min.js'></script>
    <script src="assets/js/jquery.touchSwipe.min.js"  type="text/javascript"></script>
    <script src="assets/js/gauge.js"  type="text/javascript"></script>
    <script src="assets/js/swipe.js"  type="text/javascript"></script>
    <script src="assets/js/iscroll.js"  type="text/javascript"></script>

<script type='text/javascript'>

/*
 * Videre UI library v0.1 alpha
 * Copyright (c) 2012 James G Jenner
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see http://www.gnu.org/licenses/
 */

/** iScroll logic  */
 
var verticalScroll;
// var horizontalScroll = new Array();
function loaded() {
  verticalScroll = new iScroll('leftSidebar');
  /*
  horizontalScroll[0] = new iScroll('vehicle1ContentSlider', {
    snap: true,
    hScroll: true,
    vScroll: false,
    momentum: false,
    hScrollbar: false,
    onScrollEnd: function () {
      // document.querySelector('#indicator > li.active').className = '';
      // document.querySelector('#indicator > li:nth-child(' + (this.currPageX+1) + ')').className = 'active';
      // update what is currently displayed
    }
  });
  horizontalScroll[1] = new iScroll('vehicle2ContentSlider', {
    snap: true,
    hScroll: true,
    vScroll: false,
    momentum: false,
    hScrollbar: false
  });
  horizontalScroll[2] = new iScroll('vehicle3ContentSlider', {
    snap: true,
    hScroll: true,
    vScroll: false,
    momentum: false,
    hScrollbar: false
  });
  */
}

document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

/* * * * * * * *
 *
 * Use this for high compatibility (iDevice + Android)
 *
 */
document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);
/*
 * * * * * * * */


/* * * * * * * *
 *
 * Use this for iDevice only
 *
 */
//document.addEventListener('DOMContentLoaded', loaded, false);
/*
 * * * * * * * */


/* * * * * * * *
 *
 * Use this if nothing else works
 *
 */
//window.addEventListener('load', setTimeout(function () { loaded(); }, 200), false);
/*
 * * * * * * * */

/** end iScroll logic */
 
/* 
 * this detects touch events and changes them to mousedown, mousemove and mouseup 
 * this is to support dnd
 * 
 * ideally, the approach would be to use a hold touch to activate drag mode, and 
 * then possibly an action to confirm and another to cancel the action
 *
 * the problem with html5 dnd is that there is no clear way to cancel or to manage
 * what triggers the event. It could be better to perform drag and drop manually, 
 * instead of using the html5 approach.
 *
 * Another option is to enable arrangement mode, which would enable drag and drop,
 * and then it could be disabled. Maybe an option to save arrangements, select 
 * previously saved arrangements and so on.
 */
function touchHandler(event) {
    var touches = event.changedTouches,
        first = touches[0],
        type = "";
    
    switch(event.type) {
        case "touchstart": type = "mousedown"; break;
        case "touchmove":  type="mousemove"; break;        
        case "touchend":   type="mouseup"; break;
        default: return;
    }
    
    var simulatedEvent = document.createEvent("MouseEvent");
    
    simulatedEvent.initMouseEvent(type, true, true, window, 1,
                              first.screenX, first.screenY,
                              first.clientX, first.clientY, false,
                              false, false, false, 0/*left*/, null);
    
    first.target.dispatchEvent(simulatedEvent);
    event.preventDefault();
}

var connected = false;
var halEnabled = false;
var sidebarDisplayed = false;

var PAYLOAD_TAB = 0;
var TELEMETY_TAB = 1;
var FLIGHT_PLAN_TAB = 2;
var REMOTE_CONTROL_TAB = 3;

var PAYLOAD_TAB_CONTROL = 'PayloadTabControl';
var TELEMETRY_TAB_CONTROL = 'TelemetryTabControl';
var FLIGHTPLAN_TAB_CONTROL = 'FlightPlanTabControl';
var REMOTECONTROL_TAB_CONTROL = 'RemoteControlTabControl';

// the currently selected control on the left side pane
var currentFocusControlId = '';
// the currently selected content based on the left side pane selection
var currentFocusContentId = '';
// the tabs for each vehicle
var vehicleTabSelection = new Array();
// the content slider for each vehicle tab
var vehicleContentSlider = new Array();

$(document).ready(function() {

  // load the toolbar
  loadToolbar();

  configureApplication();
  
  $('#toolbarAccess').swipe({
    swipeStatus:function(event, phase, direction, distance, fingerCount) {
      toolbarDisplay(direction, phase, distance);
    },
    trigerOnTouchEnd:false,
    threshold:null,
    fingers:'all'
  });

});



// setup the options in the left sidebar
function configureApplication() {
  
  
  // add welcome content
  addContentUI('welcome', 'Welcome', 'It is a cliche that most cliches are true, but then like most cliches, that cliche is untrue - Stephen Fry');
  // add welcome listener
  addListenerToSidebarControl('welcomeControl', 'welcome');

  var vehicleContentNbr = 0;
  // add vehicles
  addControlToSidebar('vehicleGroup', 'vehicle1Control', 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png', 'Thunderbird 1');
  addVehicleContentUI('vehicle1', 'Thunderbird 1', vehicleContentNbr++);
  addListenerToSidebarControl('vehicle1Control', 'vehicle1');

  addControlToSidebar('vehicleGroup', 'vehicle2Control', 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png', 'Thunderbird 2');
  addVehicleContentUI('vehicle2', 'Thunderbird 2', vehicleContentNbr++);
  addListenerToSidebarControl('vehicle2Control', 'vehicle2');
  
  addControlToSidebar('vehicleGroup', 'vehicle3Control', 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png', 'Thunderbird 3');
  addVehicleContentUI('vehicle3', 'Thunderbird 3', vehicleContentNbr++);
  addListenerToSidebarControl('vehicle3Control', 'vehicle3');

  // add the add vehicle
  addControlToSidebar('vehicleGroup', 'addVehicleControl', 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png', 'Add Vehicle');
  addContentUI('addVehicle', 'Add Vehicle', 'Everything in life is somewhere else, and you get there in a car - E. B. White');
  // add listeners to the controls that adds a vehicle
  addListenerToSidebarControl('addVehicleControl', 'addVehicle');
  
  // add servers
  addControlToSidebar('serverGroup', 'server1Control', 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png', 'Main Host');
  addContentUI('server1', 'Main Host', 'This will have controls for the host, or at least some info about it');
  addListenerToSidebarControl('server1Control', 'server1');
  
  // add the add server
  addControlToSidebar('serverGroup', 'addServerControl', 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png', 'Add Host');
  addContentUI('addServer', 'Add Host', "If you hack the Vatican server, have you tampered in God's domain? - Aaron Allston");
  // add listeners to the controls that adds a server
  addListenerToSidebarControl('addServerControl', 'addServer');
  
  // add the preferences content
  addContentUI('preferences', 'Preferences', "Here be dragons");
  // add listeners to the control for the preferences
  addListenerToSidebarControl('preferencesControl', 'preferences');
  
  // set the initial focus to the welcome control
  setFocus('welcomeControl', 'welcome');
}

/*
 * addActionBar('mainApplication', 'vehicle1', 'Thunderbird 3');
 */
function addActionBar(targetId, id, title) {
  $('#' + targetId).prepend(
    '  <div id="' + id + 'TaskBar" class="taskBar boxLayout">' +
    '    <div id="leftSidebarControl' +  id + '" class="sidebarPanel noflex centered">' +
    '      <img src="icons/android/icon_xhdpi.png" class="centered" height="34px" width="34px" alt="icon">' +
    '    </div>' +
    '    <div id="leftSidebarControlText' +  id + '" class="title">' + title + '</div>' +
    '    <div id="' + id + 'TabBar" class="tabBar flex boxLayout">' +
    '    </div>' +
    '    <div id="rightSidebarControl" class="sidebarPanel noflex"></div>' +
    '  </div>');
  
  // add listener to the control that activates the left sidebar
  $('#leftSidebarControl' + id).click(function() {
    showLeftSidebar();
    
    return false;
  });
  $('#leftSidebarControlText' + id).click(function() {
    showLeftSidebar();
    
    return false;
  });
}

/*
 * addTabToActionBar('vehicle1', 'vehicle1PayloadTab', 'Payload');
 * addDividerToActionBar('vehicle1');
 * addTabToActionBar('vehicle1', 'vehicle1TelemetryTab', 'Telemetry');
 * addDividerToActionBar('vehicle1');
 * addTabToActionBar('vehicle1', 'vehicle1FlightPlanTab', 'Navigation');
 * addDividerToActionBar('vehicle1');
 * addTabToActionBar('vehicle1', 'vehicle1RemoteControlTab', 'Remote Control');
 */

function addTabToActionBar(id, partialTabId, tabId, tabName, tabNumber, vehicleContentNbr, selected) {
  selected = (typeof selected === "undefined") ? false : selected;
  
  $('#' + id + 'TabBar').append(
    '      <div id="' + tabId + '" class="tabControl centered' +  (selected ? ' tabSelected' : '') + '">' + tabName + '</div>'
    );
  
  // add a listener to each tab for navigating to the correct div
  $('#' + tabId).click(function() {
    vehicleContentSlider[vehicleContentNbr].slide(tabNumber, 0);
  });
  
}

function addDividerToActionBar(id) {
    $('#' + id + 'TabBar').append(
      '      <div class="tabDivider centered"></div>'
      );
}

function addContentUI(id, title, subTitle) {
  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'Message" class="content">' +
    '    <div class="message">' +
    '      <div class="messageContents">' +
    '        <span>' + title + '</span><br/>' +
    '        <span>' + subTitle + '</span>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');

  actionBarId = id + 'ActionBar';
  addActionBar(id, actionBarId, title);

}

/*
 * addVehicleContentUI('vehicle1', 'Thunderbird 1');
 */
function addVehicleContentUI(id, title, vehicleContentNbr) {
  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'ContentSlider" class="contentSlider">' +
//    '    <div id="scroller" class="contentSlider">' +
    '    <div class="contentSlider">' +
    '      <div id="payloadContentArea" class="content" style="">' +
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO PAYLOAD FOUND</span><br/>' +
    '            <span>You can add payload monitors via settings</span>' +
    '          </div>' +
    '        </div>' +
    '      </div>' +
    '      <div id="telemetryContentArea" class="content">' +
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO TELEMETRY FOUND</span><br/>' +
    '            <span>You can add telemetry gauges via settings</span>' +
    '          </div>' +
    '        </div>' +
    '        <div id="toolbarControl" class="toolbarControl">' +
    '            <div id="toolbar" class="toolbar">' +
    '              <!-- controls are currently added here when the document is loaded, see loadToolbar() -->' +
    '            </div>' +
    '            <div id="toolbarAccess" class="toolbarAccess">' +
    '                <div id="toolbarButtonImage" class="toolbarAccessBar toolbarAccessBarInactive">' +
    '                </div>' +
    '            </div>' +
    '        </div>' +
    '      </div>' +
    '      <div id="navigationContentArea" class="content">' +
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO NAVIGATION FOUND</span><br/>' +
    '            <span>You can configure navigation options via settings</span>' +
    '          </div>' +
    '        </div>' +
    '      </div>' +
    '      <div id="remoteControlContentArea" class="content">' +
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO REMOTE CONTROL FOUND</span><br/>' +
    '            <span>The selected vehicle is not configured for remote control</span>' +
    '          </div>' +
    '        </div>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');
  
  // add the action bar and the tabs within the action bar
  actionBarId = id + 'ActionBar';
  addActionBar(id, actionBarId, title);
  addTabToActionBar(actionBarId, id, id  + PAYLOAD_TAB_CONTROL, 'Payload', PAYLOAD_TAB, vehicleContentNbr, true);
  addDividerToActionBar(actionBarId);
  addTabToActionBar(actionBarId, id, id + TELEMETRY_TAB_CONTROL, 'Telemetry', TELEMETY_TAB, vehicleContentNbr);
  addDividerToActionBar(actionBarId);
  addTabToActionBar(actionBarId, id, id + FLIGHTPLAN_TAB_CONTROL, 'Navigation', FLIGHT_PLAN_TAB, vehicleContentNbr);
  addDividerToActionBar(actionBarId);
  addTabToActionBar(actionBarId, id, id + REMOTECONTROL_TAB_CONTROL, 'Remote Control', REMOTE_CONTROL_TAB, vehicleContentNbr);
  
  vehicleTabSelection[vehicleContentNbr] = 0;
  
  
  /* TODO: appears removing the callback and adding slideCallback worked, but requires futher testing when
   * the issues with side bar navigation are sorted out
   */
  // setup the swipe using Slider for the vehicle content
  vehicleContentSlider[vehicleContentNbr] = new Swipe(document.getElementById(id + 'ContentSlider'), {
//      callback: function(e, position) { contentTabChanged(e, position, id); },
      // slideCallback: function(position) { contentTabChanged('', position, id, vehicleContentNbr); },
      slideEffect: 'android'
    });
  
  
}

/*
 * add a control to the sidebar
 */
function addControlToSidebar(groupId, id, icon, name) {
  $('#' + groupId).append(
    '<div id="' + id + '" class="sidebarControlBar">' +
    '  <div class="sidebarControlIcon"><img src="' + icon + '" class="sidebarControlIcon"/></div>' +
    '  <div class="sidebarControlText centered">' + name + '</div>' +
    '</div>');
}

function addListenerToSidebarControl(controlId, contentId) {
  $('#' + controlId).click(function() {
    setFocus(controlId, contentId);
    hideLeftSidebar();
  });
}

function contentTabChanged(e, position, id, contentNbr) {
  
  // $('#' + id).children('.tabSelected').toggleClass('tabSelected');
  // $('.tabSelected').removeClass('tabSelected');
  
  // TODO: shouldn't toggleClass be used instead of addClass?
  
  // turn off the currently selected tab
  switch(vehicleTabSelection[contentNbr]) {
    case PAYLOAD_TAB:
      $('#' + id + PAYLOAD_TAB_CONTROL).toggleClass('tabSelected');
      break;
    case TELEMETY_TAB:
      $('#' + id + TELEMETRY_TAB_CONTROL).toggleClass('tabSelected');
      break;
    case FLIGHT_PLAN_TAB:
      $('#' + id + FLIGHTPLAN_TAB_CONTROL).toggleClass('tabSelected');
      break;
    case REMOTE_CONTROL_TAB:
      $('#' + id + REMOTECONTROL_TAB_CONTROL).toggleClass('tabSelected');
      break;
  }
  
  vehicleTabSelection[contentNbr] = position;
  
  // turn on the new tab
  switch (position) {
    case PAYLOAD_TAB:
      $('#' + id + PAYLOAD_TAB_CONTROL).addClass('tabSelected');
      break;
    case TELEMETY_TAB:
      $('#' + id + TELEMETRY_TAB_CONTROL).addClass('tabSelected');
      break;
    case FLIGHT_PLAN_TAB:
      $('#' + id + FLIGHTPLAN_TAB_CONTROL).addClass('tabSelected');
      break;
    case REMOTE_CONTROL_TAB:
      $('#' + id + REMOTECONTROL_TAB_CONTROL).addClass('tabSelected');
      break;
  }
}

function setFocus(controlId, contentId) {
  // turn off the control for the current focus, if set
  if(currentFocusControlId != '') {
    $('#' + currentFocusControlId).toggleClass('sidebarControlActive');
  }
  
  // turn on the control for the set focus
  $('#' + controlId).toggleClass('sidebarControlActive');
  
  // update the focus to the set focus
  currentFocusControlId = controlId;
  
  // display the selected content before hiding, so no flickering white stuff
  $('#' + contentId).css('visibility', 'visible');
  
  // change to the appropriate application contents
  if(currentFocusContentId != '') {
    $('#' + currentFocusContentId).css('visibility', 'hidden');
  }
  
  currentFocusContentId = contentId;
}

function showLeftSidebar() {
  var obj = $('#mainApplication');
  var time = '300ms';
  var width = $('#leftSidebar').width();
  
  // get the width of the side bar and move it by that much

  if (obj.length > 0) {
    obj.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    obj.css('-moz-transition', 'all ' + time + ' ease-in-out');
    obj.css('-o-transition', 'all ' + time + ' ease-in-out');
    obj.css('transition', 'all ' + time + ' ease-in-out');

    obj.css('-webkit-transform', 'translate(' + width + 'px, 0px)');
    obj.css('-moz-transform', 'translate(' + width + 'px, 0px)');
    obj.css('-o-transform', 'translate(' + width + 'px, 0px)');
    obj.css('transform', 'translate(' + width + 'px, 0px)');
    sidebarDisplayed = true;

    /*
     * TODO: check if the overlay div should be animated at the same time as the main application
     * if we don't do this, it may be possible that a person tries to abort the showing of the side
     * panel by pressing/clicking on the content but it wont work due to how it doesn't cover
     * everywhere yet...
     */
    
    // check if the overlay div exists, if not then create it
    // TODO: determine if the overlay div should always exist and remove this logic to add it
    if ($('#mainApplicationOverlay').length <= 0) {
      // create a div to overlay the main application
      // this is to capture presses/clicks so as to restore the main application
          
      $(document.body).append('<div ' + 'id="mainApplicationOverlay" class="mainApplicationOverlay" ></div>');
      $('#mainApplicationOverlay').css('left', width + 'px');

      // setup listener to restore main application
      $('#mainApplicationOverlay').on('click', hideLeftSidebar);
    }
    
    // make the overlay div active by making it visible
    $('#mainApplicationOverlay').css('visibility', 'visible');
  }
}

function hideLeftSidebar() {
  var obj = $('#mainApplication');
  var time = '300ms';
  var width = $('#leftSidebar').width();
  
  if (obj.length > 0) {
    // make the overlay div inactive by making it invisible
    $('#mainApplicationOverlay').css('visibility', 'hidden');
    
    obj.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    obj.css('-moz-transition', 'all ' + time + ' ease-in-out');
    obj.css('-o-transition', 'all ' + time + ' ease-in-out');
    obj.css('transition', 'all ' + time + ' ease-in-out');

    obj.css('-webkit-transform', 'translate(0px, 0px)');
    obj.css('-moz-transform', 'translate(0px, 0px)');
    obj.css('-o-transform', 'translate(0px, 0px)');
    obj.css('transform', 'translate(0px, 0px)');
  }
  

  sidebarDisplayed = false;
}


// define gauges
var videoGauge = new Gauge({name: 'video', title: 'Video', description: 'Live video feed',
				 icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_video.png',
				 contentIsCanvas: true});
var speedGauge = new Gauge({name: 'speed', title: 'Speed', description: 'Relative to surounding air',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/speed_background_s.png',
			         needleImg1: 'assets/gauges/speed_needle.png',
			         foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
			         });
var attitudeGauge = new Gauge({name: 'attitude', title: 'Attitude', description: 'Orientation aroud the center of mass',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         overlayImg: 'assets/gauges/attitude_foreground_s.png',
			         foregroundImg: 'assets/gauges/gauge_base_plate_s.png',
				 foregroundClips: true,
			         needleImg1: 'assets/gauges/attitude_horizon_s.png',
				 needleImg1Rotates: true,
				 needleImg1VerticalScroll: true,
				 needleImg1VerticalScrollType: 'relative',
				 needleImg1XOffset: '-161px',
				 needleImg1Height: '830px',
			         needleImg2: 'assets/gauges/attitude_needle_s.png',
				 mask: 'assets/gauges/gauge_base_mask_s.png'
			         });
var altimeterGauge = new Gauge({name: 'altimeter', title: 'Altimeter', description: 'Altitude above mean sea level',
			          icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/altimeter_background_s.png',
			         needleImg1: 'assets/gauges/altimeter_large_needle_s.png',
			         needleImg2: 'assets/gauges/altimeter_small_needle_s.png',
			         foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
			         });

var headingGauge = new Gauge({name: 'heading', title: 'Heading', description: 'Direction in respect to magnetic north',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/compass_background_s.png',
			         needleImg1: 'assets/gauges/compass_needle_s.png'
			         });
				
var vsiGauge = new Gauge({name: 'vsi', title: 'VSI', description: 'Vertical speed indicator',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/vsi_background_s.png',
			         needleImg1: 'assets/gauges/vsi_needle_s.png',
			         foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
			         });
				
var thermometerGauge = new Gauge({name: 'thermometer', title: 'Thermometer', description: 'Engine tempurature',
				 icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
				 dialImg: 'assets/gauges/thermometer_background_s.png',
				 needleImg1: 'assets/gauges/thermometer_needle_s.png',
				 foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
				 });

/*
 * setGaugeAngle()
 *
 * example:
 *
  // angle was calculated roughly from image, may need adjustment
  var degree = 1.615;
  var value = 1.615 * 100;
 * setInstrument('speed', 'needle', myWidgetAngle, 45, '200ms')
 */
function setGaugeAngle(gauge, indicatorName, degree, time) {
  // lets play with the speed
  var currentAngle = 0; 
  var direction = 1;  // default positive

  var obj = $('#instrument' + gauge.name + '_' + indicatorName);

  if (obj.length > 0) {
    obj.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    obj.css('-moz-transition', 'all ' + time + ' ease-in-out');
    obj.css('-o-transition', 'all ' + time + ' ease-in-out');
    obj.css('transition', 'all ' + time + ' ease-in-out');

    origin = '50% 50%';
    obj.css('-webkit-transform-origin', origin);
    obj.css('-moz-transform-origin', origin);
    obj.css('-o-transform-origin', origin);
    obj.css('transform-origin', origin);

    
    obj.css('-webkit-transform', 'rotate(' + degree + 'deg)');
    obj.css('-moz-transform', 'rotate(' + degree + 'deg)');
    obj.css('-o-transform', 'rotate(' + degree + 'deg)');
    obj.css('transform', 'rotate(' + degree + 'deg)');
  }
}

function setGauge(gauge, indicatorName, degree, value, time) {
  // lets play with the speed
  var currentAngle = 0; 
  var direction = 1;  // default positive

  var obj = $('#instrument' + gauge.name + '_' + indicatorName);

  if (obj.length > 0) {
    obj.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    obj.css('-moz-transition', 'all ' + time + ' ease-in-out');
    obj.css('-o-transition', 'all ' + time + ' ease-in-out');
    obj.css('transition', 'all ' + time + ' ease-in-out');

    origin = '50% 50%';
    obj.css('-webkit-transform-origin', origin);
    obj.css('-moz-transform-origin', origin);
    obj.css('-o-transform-origin', origin);
    obj.css('transform-origin', origin);

    
    obj.css('-webkit-transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
    obj.css('-moz-transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
    obj.css('-o-transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
    obj.css('transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
  }
}

function enableHal() {
  halEnabled = true;

  // lets play with the direction
  setGaugeAngle(headingGauge, 'needle1', 176, '2s');
  setGaugeAngle(thermometerGauge, 'needle1', 90, '750ms');
  setGaugeAngle(vsiGauge, 'needle1', 98, '1s');
  setGaugeAngle(altimeterGauge, 'needle1', 45, '1s');
  setGaugeAngle(altimeterGauge, 'needle2', 36, '1s');
  setGaugeAngle(speedGauge, 'needle1', 45, '500ms');

  setGaugeAngle(attitudeGauge, 'needle2', 45, '750ms');
  setGauge(attitudeGauge, 'needle1', 45, '25px', '750ms');
  
  performVideoCountdown(videoGauge);
}

function disableHal() {
  halEnabled = false;

  setGaugeAngle(headingGauge, 'needle1', 0, '500ms');
  setGaugeAngle(thermometerGauge, 'needle1', 0, '300ms');
  setGaugeAngle(vsiGauge, 'needle1', 0, '300ms');
  setGaugeAngle(altimeterGauge, 'needle1', 0, '300ms');
  setGaugeAngle(altimeterGauge, 'needle2', 0, '300ms');
  setGaugeAngle(speedGauge, 'needle1', 0, '300ms');

  setGaugeAngle(attitudeGauge, 'needle2', -45, '750ms');
  setGauge(attitudeGauge, 'needle1', -45, '-25px', '750ms');
  
}

function initialiseVideoCountdown(gauge) {
}

function performVideoCountdown(gauge) {
  canvas = document.getElementById(gauge.canvasId);
  ctx = canvas.getContext('2d');
  canvas_size = [canvas.width, canvas.height];
  radius = Math.min(canvas_size[0], canvas_size[1]) / 2;
  center = [canvas_size[0]/2, canvas_size[1]/2];
  start = 1;
  fps = 40;
  seconds = 2;
  
  var total = fps*seconds;
  
  for(var i=total;i>=0;i--) {
    var delayed = (function(){
      var step = 1-i/total;
      var left = Math.ceil(i/fps);
      
      return function() {
	// num.innerHTML=left;
	draw_next(step);
      };
    })();
    
    setTimeout(delayed, -1000 / fps * (i-total));
  }
}

function draw_next(step) { // step between 0 and 1
  ctx.clearRect(0,0,canvas_size[0], canvas_size[1]);
  
  if(step < 1) {
    ctx.beginPath();
    ctx.moveTo(center[0], center[1]); // ponto central
    
    ctx.arc(  // draw next arc
      center[0],
      center[1],
      radius,
      Math.PI * (-0.5 + 0), // -0.5 pra começar do topo
      Math.PI * (-0.5 + step*2),
      true // anti horário
      );
    
    ctx.lineTo(center[0], center[1]); // line back to the center
    ctx.closePath();
    
    ctx.fillStyle = 'rgb(40,40,40)';    // color
    
    ctx.fill();
  }
}

				 
/*
 * loadToolbar - loads the toolbar
 */
function loadToolbar() {
  // TODO: determine how to handle adding a control for a gauge vs a non gauge toggling control. maybe seperate methods?
  /**
   * for (var i=0; i < obj.length; i++) {
    
   }
   */
  /*
   * TODO: maybe define a control that is icon, title and name, or is that redundant when it's incorporated into the Gauge?
   * maybe the title and description should be removed from Gauge and added to a new type called Control.... Then the control
   * could be linked to the gauge so it knows what it controls... 
   */
  
  // TODO: load this information from remote source or from local storage...
  
  addControlToToolbar('toggleConnection',  'assets/icons/drawable-xhdpi-v11/ic_stat_power.png',   'Connection',  'Connectivity to the vehicle');
  addControlToToolbar('toggleHal',         'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',   'Hal 9000',    'Test to control guages');
  
  addControlToToolbar('toggle' + videoGauge.name, videoGauge.icon, videoGauge.title, videoGauge.description);

  addControlToToolbar('toggle' + speedGauge.name, speedGauge.icon, speedGauge.title, speedGauge.description);
  addControlToToolbar('toggle' + attitudeGauge.name, attitudeGauge.icon, attitudeGauge.title, attitudeGauge.description);
  addControlToToolbar('toggle' + altimeterGauge.name, altimeterGauge.icon, altimeterGauge.title, altimeterGauge.description);
  addControlToToolbar('toggle' + headingGauge.name, headingGauge.icon, headingGauge.title, headingGauge.description);
  addControlToToolbar('toggle' + vsiGauge.name, vsiGauge.icon, vsiGauge.title, vsiGauge.description);
  addControlToToolbar('toggle' + thermometerGauge.name, thermometerGauge.icon, thermometerGauge.title, thermometerGauge.description);

  $('#toggleConnection').click(function() {
    if(connected) {
      disconnect();
    } else {
      connect();
    }
    return false;
  });

  $('#toggleHal').click(function() {
    if(halEnabled) {
      disableHal();
      $('#toggleHal' + 'ControlArea').toggleClass('controlIconAreaSelected');
    } else {
      enableHal();
      $('#toggleHal' + 'ControlArea').toggleClass('controlIconAreaSelected');
    }
    return false;
  });

  // define the function for toggling the gauge control
  var toggleGaugeFn = function(gauge) {
    if(gauge.enabled) {
      gauge.enabled = !hideGauge(gauge.id);
      $('#toggle' + gauge.name + 'ControlArea').toggleClass('controlIconAreaSelected');
    } else {
      gauge.enabled = showGauge(gauge);
      $('#toggle'  + gauge.name + 'ControlArea').toggleClass('controlIconAreaSelected');
    }
    return false;
  }
  
  $('#toggle' + videoGauge.name).click(function() {toggleGaugeFn(videoGauge)});
  $('#toggle' + speedGauge.name).click(function() {toggleGaugeFn(speedGauge)});
  $('#toggle' + attitudeGauge.name).click(function() {toggleGaugeFn(attitudeGauge)});
  $('#toggle' + altimeterGauge.name).click(function() {toggleGaugeFn(altimeterGauge)});
  $('#toggle' + headingGauge.name).click(function() {toggleGaugeFn(headingGauge)});
  $('#toggle' + vsiGauge.name).click(function() {toggleGaugeFn(vsiGauge)});
  $('#toggle' + thermometerGauge.name).click(function() {toggleGaugeFn(thermometerGauge)});
}

/*
 * addControlToToolbar - adds a new control entry to the toolbar
 *
 * id      the id for the control
 * icon    the icon representing the gaugue
 * name    the name of the control
 * subText a description of the control
 */

function addControlToToolbar(id, icon, name, subText) {
  $('#toolbar').append(
    '<div id="' + id + '" class="controlBar">' +
    '  <div id="' + id + 'ControlArea" class="controlIconArea">' +
    '    <img class="controlIcon" src="' + icon + '" />' +
    '  </div>' +
    '  <div class="controlText">' +
    '    <div class="controlName">' +
           name + 
    '    </div>' +
    '    <div class="controlSubText">' +
           subText + 
    '    </div>' +
    '  </div>' +
    /*
    '  <div class="controlToggle">' +
    '    <img class="controlToggleImage" src="assets/icons/drawable-xhdpi-v11/ic_stat_unlocked.png" />' +
    '  </div>' +
    '  <div class="controlToggle">' +
    '    <img class="controlToggleImage" src="assets/icons/drawable-xhdpi-v11/ic_stat_hidden.png" />' +
    '  </div>' +
    */
    '</div>');
}

var toolbarHidden = true;

function toolbarDisplay(direction, phase, distance) {
  // it is apparent that the start phase often doesn't have direction
  
  switch(phase) {
    case "start":   // swipe has started
      if(toolbarHidden) {
        // make bar active
        $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');

	// TODO: change the +/- to use the size from css
	
        // animate bar
        $('#toolbarControl').animate({
          'right': '+=250px'
        }, 300, function() {
          $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');
          toolbarHidden = false;
        });
      } else {
        $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');
        
        $('#toolbarControl').animate({
          'right': '-=250px'
        }, 300, function() {
          $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');
          toolbarHidden = true;
        });
      }
      break;
      
    case "cancel":  // swipe has been cancelled (didn't travel far enough)
      break;
    
    case "end":     // swipe is successful
      break;
      
    case "move":    // swipe is moving
      break;
    
  }
}

/*
 * showGauge() displays a panel, creating it if it doesn't exist
 * 
 * gauge - the gauge to display
 *
 * returns true if the panel is sucessfully displayed
 */
function showGauge(gauge) {
  // default values
  /* TODO: add in x, y so as to be able to set where it is when displaying for the first time
  panelWidth = (typeof optionalArg === "undefined") ? '100%' : panelWidth;
  panelHeight = (typeof optionalArg === "undefined") ? '100%' : panelHeight;
  x = (typeof optionalArg === "undefined") ? '100px' : x;
  y = (typeof optionalArg === "undefined") ? '100px' : y;
  */

  // if the panel doesn't exist then add it
  if ($('#' + gauge.id).length <= 0) {
    // create the div with the appropriate images
			    
    // NOTE: when not using img to load the svg, need to overlay a transparent div so drag'n'drop will still work, don't really need it here
    // TODO: check removing the drag div
    
    var gaugeHTML = '';

    gaugeHTML +=
      '<div ' + 'id="' + gauge.id + '" class="viewPanel">';
    
    if(gauge.contentIsCanvas) {
      gaugeHTML +=
	'<canvas id="' + gauge.canvasId + '" class="gaugeOverlay" width="' + gauge.width + '" height="' + gauge.height + '" >no Canvas for you</canvas>';
    } else {
      // some gauges may not have a background
      if(typeof gauge.backgroundImg != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gauge.name + '_background" class="gaugeOverlay gaugeBackground" src="' + gauge.backgroundImg + '" width="' + gauge.width + '" height="' + gauge.height + '" />';
      }

      // add the dial image
      if(typeof gauge.dialImg != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gauge.name + '_dial" class="gaugeOverlay gaugeBackground" src="' + gauge.dialImg + '" width="' + gauge.width + '" height="' + gauge.height + '" />';
      }
  
      // if the first needle is specified, then set
      if(typeof gauge.needleImg1 != "undefined") {
	if(typeof gauge.needleImg1XOffset != "undefined") {
	gaugeHTML += 
	//'<img id="instrument' + gauge.name + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg1    + '" width="' + gauge.width + '" height="' + gauge.needleImg1Height + '" />';
	'<img id="instrument' + gauge.name + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg1    + '" width="' + gauge.width + '" style="top: ' + gauge.needleImg1XOffset + '"/>';
	} else {
	gaugeHTML += 
	//'<img id="instrument' + gauge.name + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg1    + '" width="' + gauge.width + '" height="' + gauge.needleImg1Height + '" />';
	'<img id="instrument' + gauge.name + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg1    + '" width="' + gauge.width + '" />';
	}
      }
	
      // if the second needle is specified, then set
      if(typeof gauge.needleImg2 != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gauge.name + '_needle2"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg2    + '" width="' + gauge.width + '" height="' + gauge.height + '" />';
      }
	
      // if the third needle is specified, then set
      if(typeof gauge.needleImg3 != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gauge.name + '_needle3"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg3    + '" width="' + gauge.width + '" height="' + gauge.height + '" />';
      }

      if(typeof gauge.overlayImg != "undefined") {
	gaugeHTML += 
	  '<img id="instrument' + gauge.name + '_overlay" class="gaugeOverlay gaugeForeground" src="' + gauge.overlayImg + '" width="' + gauge.width + '" height="' + gauge.height + '" />';
      }
	
      if(typeof gauge.foregroundImg != "undefined") {
	gaugeHTML += 
	  '<img id="instrument' + gauge.name + '_foreground" class="gaugeOverlay gaugeForeground" src="' + gauge.foregroundImg + '" width="' + gauge.width + '" height="' + gauge.foregroundHeight + '" />';
      }
    }
      
    gaugeHTML += 
      '<div id="gauge_' + gauge.name + 'Drag" class="gaugeDrag" width="' + gauge.width + '" height="' + gauge.height + '" />' +
      '</div>';
	
    $(document.body).append(gaugeHTML);
     
    if(typeof gauge.mask != "undefined") {
      $('#' + gauge.id).css('-webkit-mask-image', 'url(' + gauge.mask + ')');
    }
     
    panelElement = document.getElementById(gauge.id);
      
    // add the touch handler for dragging
    panelElement.addEventListener("touchstart", touchHandler, true);
    panelElement.addEventListener("touchmove", touchHandler, true);
    panelElement.addEventListener("touchend", touchHandler, true);
    panelElement.addEventListener("touchcancel", touchHandler, true);

    // todo: only set to draggable based on condition
    // set it draggable
    // test if we can use panelElement instead of searching for it again
    $("#" + gauge.id).draggable({
      grid: [5, 5],
      containment: 'parent',
      opacity: 0.50,
      snap: true,
      snapMode: 'outer',
      snapTolerance: 5,
      revert:false
    });

    // as we are creating it, set the position to top left
    
    $('#' + gauge.id).css({
	  position: 'absolute',
	  'z-index': 50,
      top : 50,
      left : 50
	});
  }
  
  // show the panel 
  // todo: add animation
  $('#' + gauge.id).show();
  
  return true;
}

/*
 * hideGauge() - disables a panel based on a toggle control and uses SVG for the contents
 *
 * gaugeId: the id for the gauge that is being hidden
 *
 * returns true if panel is hidden
 * 
 * Example:
 * speedEnabled = !hideGauge('speedPanel')
 */
function hideGauge(gaugeId) {
  // hide the panel for the gauge
  // todo: add animation
  $('#' + gaugeId).hide();
  
  return true;
}

// shim with requestAnimationFrame/cancelAnimationFrame - sourced from http://creativejs.com/resources/requestanimationframe/
// requestAnimationFrame polyfill by Erik Möller
// fixes from Paul Irish and Tino Zijdel

// TODO: which is better, this or the Paul Irish/Jerome Etienne Notes one?
(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());


// shim layer with setTimeout fallback, originally by Paul Irish
// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
/*
window.requestAnimFrame = (function(){
    return  window.requestAnimationFrame   || 
        window.webkitRequestAnimationFrame || 
        window.mozRequestAnimationFrame    || 
        window.oRequestAnimationFrame      || 
        window.msRequestAnimationFrame     || 
        function(callback, element){
            return window.setTimeout(callback, 1000 / 60);
        };
})();
*/

// shim layer for cancel, derived from Paul Irish, by Jerome Etienne Notes
/*
window.cancelRequestAnimFrame = ( function() {
    return window.cancelAnimationFrame           ||
        window.webkitCancelRequestAnimationFrame ||
        window.mozCancelRequestAnimationFrame    ||
        window.oCancelRequestAnimationFrame      ||
        window.msCancelRequestAnimationFrame     ||
        clearTimeout
} )();
*/
  
/* connection logic for websockets */

var connection = {};

function connect() {
  if(window.WebSocket != undefined) {
    if(connection.readyState === undefined || connection.readyState > 1) {
      connection = new WebSocket('ws://localhost:9007', "myProtocol");
      // connection = new WebSocket('ws://localhost:8095', 'http-only');

      connection.binaryType = "arraybuffer";
      connection.onopen = openEvent;
      connection.onmessage = messageEvent;
      connection.onclose = closeEvent;
      connection.onerror = errorEvent;
    }
  }
}

function disconnect() {
  connection.close();
}

function openEvent(event) {
  console.log(event);
  connected = true;
  // $(this).children('img').attr('src', 'assets/icons/icon_power_on.svg');
  $('#toggleConnection').children('img').attr('src', 'assets/icons/icon_power_on.svg');
}

function closeEvent(event) {
  console.log(event);
  connected = false;
  // $(this).children('img').attr('src', 'assets/icons/icon_power_off.svg');
  $('#toggleConnection').children('img').attr('src', 'assets/icons/icon_power_off.svg');
}

function messageEvent(event) {
  // var chatdiv = document.getElementById('chat');
  // chatdiv.innerHTML = chatdiv.innerHTML + event.data + "<br />";

  if(event.data instanceof ArrayBuffer) {
    console.log(event);
/*
    var bytearray = new Uint8Array(event.data);

    var tempcanvas = document.createElement('canvas');
        tempcanvas.height = imageheight;
        tempcanvas.width = imagewidth;
    var tempcontext = tempcanvas.getContext('2d');

    var imgdata = tempcontext.getImageData(0,0,imagewidth,imageheight);

    var imgdatalen = imgdata.data.length;

    for (var i=8; i < imgdatalen; i++) {
      imgdata.data[i] = bytearray[i];
    }

    tempcontext.putImageData(imgdata,0,0);

    var img = document.createElement('img');
        img.height = imageheight;
        img.width = imagewidth;
        img.src = tempcanvas.toDataURL();

    chatdiv.appendChild(img);
    chatdiv.innerHTML = chatdiv.innerHTML + '<br/>';
*/
  } else {
    console.log(event, event.data);
  }
}

function errorEvent(event) {
  console.log(event);
  // document.getElementById('chat').innerHTML = "There was an error: " + event.data;
}

function sendMessage() {
  var messageText = "blah";
  // var messageText = = document.getElementById('chatmessage').value;
  // messageText = username + ": " + messageText;
  connection.send(messageText);
}

</script>
  </head>
  <body>
    <div id="leftSidebar" class="sideBar">
      <div id="scroller">
      <div class="sidebarGroupHeading">

      </div>
      <div id="welcomeControl" class="sidebarControlBar">
        <div class="sidebarControlIcon"><img src='assets/icons/drawable-xhdpi-v11/ic_stat_compass.png' class="sidebarControlIcon"/></div>
        <div class="sidebarControlText centered">Welcome</div>
      </div>
      <div id="vehicleGroup" class="sidebarGroup">
        <div class="sidebarGroupHeading">
          <div id="vehicleGroupTitle" class="sidebarGroupTitle">Vehicles</div>
        </div>
      </div>
      <div id="serverGroup" class="sidebarGroup">
        <div class="sidebarGroupHeading">
          <div id="serversGroupTitle" class="sidebarGroupTitle">Servers</div>
        </div>
      </div>
      <div class="sidebarGroupHeading">
        <div id="preferencsGroupTitle" class="sidebarGroupTitle"></div>
      </div>
      <div id="preferencesControl" class="sidebarControlBar">
        <div class="sidebarControlIcon"><img src='assets/icons/drawable-xhdpi-v11/ic_stat_compass.png' class="sidebarControlIcon"/></div>
        <div class="sidebarControlText centered">Preferences</div>
      </div>
      </div>
    </div>

    <div id="mainApplication" class="mainApplication content">
      <!-- app content goes here -->
    </div>
  </body>
</html>
