<!doctype html>
<html>
  <head>
    <meta charset='UTF-8' />
    <!-- need to invesitgate the use of the viewport option, it doesn't appear to be working, see
         http://developer.android.com/guide/webapps/targeting.html
         http://developer.android.com/guide/webapps/best-practices.html
         
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0' />
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

    <title>Videre</title>
    
    <link rel="stylesheet" type="text/css" href="assets/css/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type='text/javascript' src='assets/js/jquery-1.8.0.min.js'></script>
    <script type='text/javascript' src='assets/js/jquery-ui-1.8.23.custom.min.js'></script>
    <script src="assets/js/jquery.touchSwipe.min.js"  type="text/javascript"></script>
    <script src="assets/js/swipe.js"  type="text/javascript"></script>
    <script src="assets/js/iscroll.js"  type="text/javascript"></script>
    <script src="assets/js/gauge.js"  type="text/javascript"></script>
    <script src="assets/js/contentmanager.js"  type="text/javascript"></script>
    <script src="assets/js/leaflet-src.js"  type="text/javascript"></script>

<script type='text/javascript'>

/*
 * Videre UI library v0.1 alpha
 * Copyright (c) 2012 James G Jenner
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3 of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see http://www.gnu.org/licenses/
 */

/** iScroll logic  */
/* don't need to access the scroll bar for side panes  
var verticalScrollLeftSidebar;
var verticalScrollRightSidebar;
*/
// var horizontalScroll = new Array();
function loaded() {
  new iScroll(LEFT_SIDEBAR_ID);
  new iScroll('rightSidebar');
  /*
  verticalScrollLeftSidebar = new iScroll(LEFT_SIDEBAR_ID);
  verticalScrollRightSidebar = new iScroll('rightSidebar');
  */
  /*
  horizontalScroll[0] = new iScroll('vehicle1ContentSlider', {
    snap: true,
    hScroll: true,
    vScroll: false,
    momentum: false,
    hScrollbar: false,
    onScrollEnd: function () {
      // document.querySelector('#indicator > li.active').className = '';
      // document.querySelector('#indicator > li:nth-child(' + (this.currPageX+1) + ')').className = 'active';
      // update what is currently displayed
    }
  });
  horizontalScroll[1] = new iScroll('vehicle2ContentSlider', {
    snap: true,
    hScroll: true,
    vScroll: false,
    momentum: false,
    hScrollbar: false
  });
  horizontalScroll[2] = new iScroll('vehicle3ContentSlider', {
    snap: true,
    hScroll: true,
    vScroll: false,
    momentum: false,
    hScrollbar: false
  });
  */
}

document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

/* * * * * * * *
 *
 * Use this for high compatibility (iDevice + Android)
 *
 */
document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);
/*
 * * * * * * * */


/* * * * * * * *
 *
 * Use this for iDevice only
 *
 */
//document.addEventListener('DOMContentLoaded', loaded, false);
/*
 * * * * * * * */


/* * * * * * * *
 *
 * Use this if nothing else works
 *
 */
//window.addEventListener('load', setTimeout(function () { loaded(); }, 200), false);
/*
 * * * * * * * */

/** end iScroll logic */
 
/* 
 * this detects touch events and changes them to mousedown, mousemove and mouseup 
 * this is to support dnd
 * 
 * ideally, the approach would be to use a hold touch to activate drag mode, and 
 * then possibly an action to confirm and another to cancel the action
 *
 * the problem with html5 dnd is that there is no clear way to cancel or to manage
 * what triggers the event. It could be better to perform drag and drop manually, 
 * instead of using the html5 approach.
 *
 * Another option is to enable arrangement mode, which would enable drag and drop,
 * and then it could be disabled. Maybe an option to save arrangements, select 
 * previously saved arrangements and so on.
 */
function touchHandler(event) {
    var touches = event.changedTouches,
        first = touches[0],
        type = "";
    
    switch(event.type) {
        case "touchstart": type = "mousedown"; break;
        case "touchmove":  type="mousemove"; break;        
        case "touchend":   type="mouseup"; break;
        default: return;
    }
    
    var simulatedEvent = document.createEvent("MouseEvent");
    
    simulatedEvent.initMouseEvent(type, true, true, window, 1,
                              first.screenX, first.screenY,
                              first.clientX, first.clientY, false,
                              false, false, false, 0/*left*/, null);
    
    first.target.dispatchEvent(simulatedEvent);
    event.preventDefault();
}

var connected = false;
var halEnabled = false;

var PAYLOAD_TAB = 0;
var TELEMETY_TAB = 1;
var FLIGHT_PLAN_TAB = 2;
var REMOTE_CONTROL_TAB = 3;

var PAYLOAD_TAB_CONTROL = 'PayloadTabControl';
var TELEMETRY_TAB_CONTROL = 'TelemetryTabControl';
var FLIGHTPLAN_TAB_CONTROL = 'FlightPlanTabControl';
var REMOTECONTROL_TAB_CONTROL = 'RemoteControlTabControl';

var ADD_VEHICLE_CONTROL_ID = 'addVehicleControl';
var ADD_SERVER_CONTROL_ID = 'addServerControl';

var PAYLOAD_SUB_ID = 'PayloadContentArea';
var TELEMETRY_SUB_ID = 'TelemetryContentArea';
var FLIGHTPLAN_SUB_ID = 'FlightPlanContentArea';
var REMOTECONTROL_SUB_ID = 'RemoteControlContentArea';

var VEHICLE_GROUP = 'vehicleGroup';
var VEHICLE_CONTROL = 'vehicleControl';
var VEHICLE_CONTENT = 'vehicle';

var SERVER_GROUP = 'serverGroup';
var SERVER_CONTROL = 'serverControl';
var SERVER_CONTENT = 'server';

var ADD_ICON = 'assets/icons/drawable-xhdpi-v11/ic_action_create.png';

var SERVER_ICON = 'assets/icons/drawable-xhdpi-v11/ic_action_server.png';

var AIRPLANE_ICON = 'assets/icons/drawable-xhdpi-v11/ic_action_airplane.png';
var SURFACE_ICON = 'assets/icons/drawable-xhdpi-v11/ic_action_surface.png';
var SUBMERSIBLE_ICON = 'assets/icons/drawable-xhdpi-v11/ic_action_submersible.png';

var WELCOME_CONTROL_ID = 'welcomeControl';
var WELCOME_CONTENT_ID = 'welcome';

var LEFT_SIDEBAR_ID = 'leftSidebar';

// the currently selected control on the left side pane
var currentFocusControlId = '';
// the currently selected content based on the left side pane selection
var currentFocusContentId = '';
// the tabs for each vehicle
var vehicleTabSelection = new Array();
// the content slider for each vehicle tab
var vehicleContentSlider = new Array();

var contentManager = new ContentManager();

$(document).ready(function() {

  // load the toolbar
  // TODO: remove the loadToolbar logic, only retained now to show how connectivity was performed
  // loadToolbar();

  configureApplication();
  // jgj todo: is this still required?
  /*
  $('#toolbarAccess').swipe({
    swipeStatus:function(event, phase, direction, distance, fingerCount) {
      toolbarDisplay(direction, phase, distance);
    },
    trigerOnTouchEnd:false,
    threshold:null,
    fingers:'all'
  });
  */

});

// setup the options in the left sidebar
function configureApplication() {
  // add welcome content
  addContentUI(WELCOME_CONTENT_ID, 'Welcome', 'It is a cliche that most cliches are true, but then like most cliches, that cliche is untrue - Stephen Fry');
  // add welcome listener
  addListenerToSidebarControl(LEFT_SIDEBAR_ID, WELCOME_CONTROL_ID, WELCOME_CONTENT_ID);

  // add the add vehicle
  appendControlToSidebar('vehicleGroup', ADD_VEHICLE_CONTROL_ID, ADD_ICON, 'Add Vehicle');
  addVehicleCreateUI('addVehicle', 'Add Vehicle');
  // add listeners to the controls that adds a vehicle
  addListenerToSidebarControl(LEFT_SIDEBAR_ID, 'addVehicleControl', 'addVehicle');
  
  // add the add server
  appendControlToSidebar('serverGroup', 'addServerControl', ADD_ICON, 'Add Server');
  addServerCreateUI('addServer', 'Add Server');
  // addContentUI('addServer', 'Add Host', "If you hack the Vatican server, have you tampered in God's domain? - Aaron Allston");
  // add listeners to the controls that adds a server
  addListenerToSidebarControl(LEFT_SIDEBAR_ID, 'addServerControl', 'addServer');
  
  // add the preferences content
  addContentUI('preferences', 'Preferences', "Here be dragons");
  // add listeners to the control for the preferences
  addListenerToSidebarControl(LEFT_SIDEBAR_ID, 'preferencesControl', 'preferences');
  
  // set the initial focus to the welcome control
  setFocus(WELCOME_CONTROL_ID, WELCOME_CONTENT_ID);

  contentManager.loadData();
  
  // iterate through the vehicles and load them
  for(var vehicle in contentManager.vehicles) {
    loadVehicleUIs(contentManager.vehicles[vehicle]);
  }

  // iterate through the servers and load them
  for(var server in contentManager.servers) {
    loadServerUIs(contentManager.servers[server]);
  }
}

var LEFT_SIDEBAR_CONTROL_TEXT = 'leftSidebarControlText';

/*
 * addActionBar('mainApplication', 'vehicle1', 'Thunderbird 3');
 */
function addActionBar(targetId, id, title, includeSettings, options) {

  options = options || {};

  var createServerAction = options.createServer || false;
  var createServerFunction = options.createServerFunction || '';
  var createVehicleAction = options.createVehicle || false;
  var createVehicleFunction = options.createVehicleFunction || '';
  var saveAction = options.save || false;
  var saveFunction = options.saveFunction || '';
  var removeAction = options.remove || false;
  var removeFunction = options.removeFunction || '';
  var disconnectAction = options.disconnect || false;
  var disconnectFunction = options.disconnectFunction || '';
  var connectAction = options.connect || false;
  var connectFunction = options.connectFunction || '';

  
  $('#' + targetId).prepend(
    '  <div id="' + id + 'TaskBar" class="taskBar boxLayout">' +
    '    <div id="leftSidebarControl' + id + '" class="sidebarPanel noflex centered">' +
    '      <img src="icons/android/icon_xhdpi.png" class="centered" height="34px" width="34px" alt="icon">' +
    '    </div>' +
    '    <div id="' + LEFT_SIDEBAR_CONTROL_TEXT + id + '" class="title">' + title + '</div>' +
    '    <div id="' + id + 'TabBar" class="tabBar flex boxLayout">' +
    '    </div>' +
    
    // check the actions that are to be available... settings (if enabled) always goes last
    (createServerAction ? 
    '    <div id="createServerActionControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_create.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '      <span class="actionBarText">Add server</span>' +
    '    </div>'
    : '') +
    (createVehicleAction ? 
    '    <div id="createVehicleActionControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_create.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '      <span class="actionBarText">Add vehicle</span>' +
    '    </div>'
    : '') +
    (saveAction ? 
    '    <div id="saveActionControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_save.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '      <span class="actionBarText">Save</span>' +
    '    </div>'
    : '') +
    (disconnectAction ?
    '    <div id="disconnectActionControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_connection_disable.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '      <span class="actionBarText">Disconnect</span>' +
    '    </div>'
    : '') +
    (connectAction ? 
    '    <div id="connectActionControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_connection_enable.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '      <span class="actionBarText">Connect</span>' +
    '    </div>'
    : '') +
  
    (removeAction ? 
    '    <div id="removeActionControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_delete.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '      <span class="actionBarText">Delete</span>' +
    '    </div>'
    : '') +
    
    (includeSettings ? 
    '    <div id="rightSidebarControl' + id + '" class="actionBarAction noflex centered">' +
    '      <img src="assets/icons/drawable-hdpi-v11/ic_action_settings.png" class="actionBarImage" height="34px" width="34px" alt="icon">' +
    '    </div>' : '') +
    
    '  </div>');
  
  // add listener to the control that activates the left sidebar
  $('#leftSidebarControl' + id).click(function() {
    showSidebar(LEFT_SIDEBAR_ID, 'left', 'mainApplication', 'mainApplicationOverlay', 'mainApplicationOverlay', '300ms');
    
    return false;
  });
  $('#' + LEFT_SIDEBAR_CONTROL_TEXT + id).click(function() {
    showSidebar(LEFT_SIDEBAR_ID, 'left', 'mainApplication', 'mainApplicationOverlay', 'mainApplicationOverlay', '300ms');
    
    return false;
  });

  // check the actions that are to be available... settings (if enabled) always goes last
  
  // add the click events for the actions that are to be available
  if(createServerAction) {
    $('#createServerActionControl' + id).on('click', createServerFunction);
  }
  if(createVehicleAction) {
    $('#createVehicleActionControl' + id).click(function() {
      return false;
    });
  }
  if(saveAction) {
    $('#saveActionControl' + id).on('click', saveFunction);
  }
  if(removeAction) {
    $('#removeActionControl' + id).on('click', removeFunction);
  }
  if(disconnectAction) {
    $('#disconnectActionControl' + id).on('click', disconnectFunction);
  }
  if(connectAction) {
    $('#connectActionControl' + id).on('click', connectFunction);
  }
  
  if(includeSettings) {
    $('#rightSidebarControl' + id).on('click', function() {
      loadSidebar(targetId, 'rightScroller');
      showSidebar('rightSidebar', 'right', 'mainApplication', 'mainApplicationOverlay', 'mainApplicationOverlay', '300ms');
      
      return false;
    });
    /*
    $('#rightSidebarControl' + id).click(function() {
      loadSidebar(targetId, 'rightScroller');
      showSidebar('rightSidebar', 'right', 'mainApplication', 'mainApplicationOverlay', 'mainApplicationOverlay', '300ms');
      
      return false;
    });
    */
  }
}

function addHeadingToSidebar(containerId, headingSetting) {
  $('#' + containerId).append(
        '<div class="sidebarGroupHeading">' +
        '</div>' +
        '<div id="testGroup" class="sidebarGroup">' +
        '  <div class="sidebarGroupHeading">' +
        '    <div id="testGroupTitle" class="sidebarGroupTitle">' + headingSetting.title + '</div>' +
        '  </div>' +
        '</div>'
  );
}

function addToggleToSidebar() {
  
}

function addTextToSidebar() {
  
}

function addGaugeControlToSideBar(containerId, contentManager, gaugeSetting) {

/*    
    this.id = id;
    this.gauge = gauge;
    
    this.options = options || {};

    this.currentValue = this.options.currentValue || 0;
    this.x = this.options.x || 0;
    this.y = this.options.y || 0;
    this.visible = this.options.visible || false;
  */

  $('#' + containerId).append(
    '<div id="' + 'toggle' + gaugeSetting.gauge.name + '" class="controlBar">' +
    '  <div id="' + 'toggle' + gaugeSetting.gauge.name + 'ControlArea" class="controlIconArea">' +
    '    <img class="controlIcon" src="' + gaugeSetting.gauge.icon + '" />' +
    '  </div>' +
    '  <div class="controlText">' +
    '    <div class="controlName">' +
           gaugeSetting.gauge.title + 
    '    </div>' +
    '    <div class="controlSubText">' +
           gaugeSetting.gauge.description + 
    '    </div>' +
    '  </div>' +
    '</div>');

  // if the gauge is visible then enable the control  
  if(gaugeSetting.visible) {
    $('#toggle'  + gaugeSetting.gauge.name + 'ControlArea').toggleClass('controlIconAreaSelected');
  }
  
  $('#toggle' + gaugeSetting.gauge.name).click(function() {
    if(gaugeSetting.visible) {
      gaugeSetting.visible = !hideGauge(gaugeSetting.gaugeId);
    } else {
      gaugeSetting.visible = showGauge(gaugeSetting, contentManager.getFocusedTabId());
    }
    
    // toggle the control
    $('#toggle'  + gaugeSetting.gauge.name + 'ControlArea').toggleClass('controlIconAreaSelected');
    
    return false;
  });
}
 

function loadSidebar(targetId, containerId) {
  // check if contents of side bar is same as previous
  
  // it's different so destroy the contents of side bar
  $('#' + containerId).empty();
  
  // create the correct contents

  /** TODO: tidy up use of setFocusedTab, setFocusedTabNbr and setFocusedTabId */
  
  // iterate through the settings for the current pane/tab
  var tabSettings = contentManager.getFocusedTabSettings();
  if(tabSettings != undefined) {
    
    var len = tabSettings.length;
    for(var i=0; i < len; i++) {
      if(i in tabSettings) {
        if(tabSettings[i] instanceof HeadingSetting) {
          console.log("Settings: Adding heading");
          addHeadingToSidebar(containerId, tabSettings[i]);
        } else if(tabSettings[i] instanceof ToggleSetting) {
          console.log("Settings: Adding toggle");
        } else if(tabSettings[i] instanceof TextSetting) {
          console.log("Settings: Adding text");
        } else if(tabSettings[i] instanceof RangeSetting) {
          console.log("Settings: Adding range");
        } else if(tabSettings[i] instanceof GaugeSetting) {
          console.log("Settings: Adding gauge");
          addGaugeControlToSideBar(containerId, contentManager, tabSettings[i]);
        }
      }
    }
    
    
  }
  
  // setup the values of the properties for the sidebar
  
  // refresh the scroller (so it knows about the new content and will behave appropriately)
}

function addTabToActionBar(id, partialTabId, tabId, tabName, tabNumber, vehicleContentNbr, selected) {
  selected = (typeof selected === "undefined") ? false : selected;
  
  $('#' + id + 'TabBar').append(
    '      <div id="' + tabId + '" class="tabControl centered' +  (selected ? ' tabSelected' : '') + '">' + tabName + '</div>'
    );
  
  // add a listener to each tab for navigating to the correct div
  $('#' + tabId).click(function() {
    vehicleContentSlider[vehicleContentNbr].slide(tabNumber, 0);
  });
  
}

function addDividerToActionBar(id) {
  $('#' + id + 'TabBar').append(
    '      <div class="tabDivider centered"></div>'
    );
}

function resetForm(formId) {
  // todo: needs to support the custom css for toggles
  
  var form = $(formId);
  
  form.find('input:text, input:password, input:file, select, textarea').val('');
  form.find('input[type="number"]').val('');
  form.find('input:radio, input:checkbox')
    .removeAttr('checked').removeAttr('selected');

  form.find(".switch.on").toggleClass('on');
}

function createServer() {
  // get form contents
  
  server = new Server({
    'name':$('#serverCreateName').val(),
    'ipAddress':$('#serverCreateIPAddress').val(),
    'port':$('#serverCreatePort').val(),
    'protocol':$('#serverCreateProtocol').val()});
  
  // add the vehicle to the content manager
  contentManager.addServer(server, true);
  
  // persist the information
  
  // load the ui for the server
  loadServerUIs(server);

  // TODO: add a message to state that the action has been performed
  
  // reset the ui  
  resetForm('#createServerForm');
}

/**
 * unloadServersUIs(server)
 *
 * unloads the ui elements that are used for a server
 */
function unloadServerUIs(server) {
  var serverControlId = SERVER_CONTROL + server.position;
  var serverContentId = SERVER_CONTENT + server.position;

  // remove the control for accessing the server
  $('#' + serverControlId).remove();
}

/**
 * loadServerUI()
 *
 * loads the ui elements to support the passed server
 * 
 */
function loadServerUIs(server) {
  // adding the server to the content manager sets it's position
  var serverNumber = server.position;
  var serverControlId = SERVER_CONTROL + serverNumber;
  var serverContentId = SERVER_CONTENT + serverNumber;

  // add the control that lets the user select the server details UI before the add server control on the side bar
  addControlToSidebarBeforeId(ADD_SERVER_CONTROL_ID, serverControlId, SERVER_ICON, server.name);
  
  // add the listener fro the ui to activate the side bar 
  addListenerToSidebarControl(LEFT_SIDEBAR_ID, serverControlId, serverContentId, function() {
    // add the ui content for the server
    addServerContentUI(serverContentId, server);
  });
}

function addServerCreateUI(id, title) {  
  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'Form" class="formContainer">' +
    '    <div class="formContents">' +
    '      <div class="formContents">' +
    '       <form id="createServerForm">' +
    '         <ul>' + 
    '           <li>' + 
    '             <label for="serverCreateName">Name</label>' +
    '             <input type="text" name="name" id="serverCreateName" placeholder="Name" required><br>' +
    '           </li>' + 
    '           <li class="breakTop">' + 
    '             <label for="serverCreateIPAddress">IP Address</label>' +
    //'             <input type="text" name="address" id="serverCreateIPAddress" placeholder="IP Address" required pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"><br>' +
    // TODO: figure out the ip address pattern for front end validation
    '             <input type="text" name="address" id="serverCreateIPAddress" placeholder="IP Address" required ><br>' +
    '           </li>' + 
    '           <li>' + 
    '             <label for="serverCreatePort">Port</label>' +
    '             <input type="number" min="1" max="99999" name="port" id="serverCreatePort" placeholder="Port"><br>' +
    '           </li>' + 
    '           <li class="breakTop">' + 
    '             <label for="serverCreateProtocol">Protocol</label>' +
    '             <input type="text" name="protocol" id="serverCreateProtocol" placeholder="Protocol"><br>' +
    '           </li>' +
    '       </form>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');

  actionBarId = id + 'ActionBar';
  addActionBar(id, actionBarId, title, false, {
    save: true,
    saveFunction: createServer,
  });
}

function createVehicle() {
  // create a new vehicle from the form
  vehicle = new Vehicle({
    'name':$('#vehicleCreateName').val(),
    'type':$('#vehicleCreateVehicleType').val(),
    'payloadEnabled':$('#vehicleCreatePayload').is(':checked'),
    'navigationEnabled':$('#vehicleCreateNavigationEnabled').is(':checked'),
    'remoteControlEnabled':$('#vehicleCreateRemoteControl').is(':checked')});
  
  // add the vehicle to the content manager
  contentManager.addVehicle(vehicle, true);
  
  // persist the information
  
  // load the ui for the vehicle
  loadVehicleUIs(vehicle);

  // TODO: add a message to state that the action has been performed
  
  // reset the form  
  resetForm('#createVehicleForm');
  
  return false;
}

/**
 * unloadVehiclesUIs(vehicle)
 *
 * unloads the ui elements that are used for a vehicle
 */
function unloadVehicleUIs(vehicle) {
  // adding the vehicle to the content manager sets it's position
  var vehicleControlId = VEHICLE_CONTROL + vehicleNumber;
  var vehicleContentId = VEHICLE_CONTENT + vehicleNumber;

  // remove the control for accessing the vehicle
  $('#' + vehicleControlId).remove();
}

/**
 * loadVehicleUI()
 *
 * loads the ui elements to support the passed vehicle
 * 
 */
function loadVehicleUIs(vehicle) {
  // determine the icon for the vehicle
  var icon = AIRPLANE_ICON;
  
  switch(vehicle.type) {
    case VEHICLE_AIR:
      icon = AIRPLANE_ICON;
      break;
    case VEHICLE_SURFACE:
      icon = SURFACE_ICON;
      break;
    case VEHICLE_SUBMERSIBLE:
      icon = SUBMERSIBLE_ICON;
      break;
  }
  
  // adding the vehicle to the content manager sets it's position
  var vehicleNumber = vehicle.position;
  var vehicleControlId = VEHICLE_CONTROL + vehicleNumber;
  var vehicleContentId = VEHICLE_CONTENT + vehicleNumber;

  // add the control that lets the user select the vehicle content UI on the side bar
  addControlToSidebarBeforeId(ADD_VEHICLE_CONTROL_ID, vehicleControlId, icon, vehicle.name);
  
  // add the listener for the ui to activate the side bar 
  addListenerToSidebarControl(LEFT_SIDEBAR_ID, vehicleControlId, vehicleContentId, function() {
    // add the ui content for the vehicle
    addVehicleContentUI(vehicleContentId, vehicle);
  });
  
  // TODO: we have no UI to maintain the settings for the vehicle, need to add an option to provide this
  // add the ui to maintain the information for the vehicle
}

function addVehicleCreateUI(id, title) {
  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'Form" class="formContainer">' +
    '    <div class="formContents">' +
    '      <div class="formContents">' +
    '       <form id="createVehicleForm">' +
    '         <ul>' + 
    '           <li>' + 
    '             <label for="vehicleCreateName">Name</label>' +
    '             <input type="text" name="name" id="vehicleCreateName" placeholder="Name" required><br>' +
    '           </li>' +
    
    '           <li class="breakTop">' +
    '             <label for="vehicleCreateVehicleType">Type of vehicle</label>' +
    '             <select name="vehicleType" id="vehicleCreateVehicleType">' +
    '               <option value="air">Air</option>' + 
    '               <option value="surface">Surface</option>' + 
    '               <option value="submersible">Submersible</option>' + 
    '             </select><br>' + 
    '           </li>' +

    '           <li class="breakTop">' +
    '             <span class="checkboxLabel">Vehicle contains payload</span> ' +
    '             <div class="switch"><span class="thumb"></span><input type="checkbox" name="payloadEnabled" id="vehicleCreatePayload"></div>' +
    // TODO: testing the iOS style of toggle, determine if this is the way to go...
    // '             <input type="checkbox" name="payload" id="vehicleCreatePayload" /><span class="checkboxLabel">Vehicle contains payload<span><br>' + 
    '           </li>' +
    
    '           <li>' +
    // '             <input type="checkbox" name="navigationEnabled" id="vehicleCreateNavigationEnabled" /><span class="checkboxLabel">Vehicle supports navigation<span><br>' +
    '             <span class="checkboxLabel">Vehicle supports navigation</span> ' +
    '             <div class="switch"><span class="thumb"></span><input type="checkbox" name="navigationEnabled" id="vehicleCreateNavigationEnabled"></div>' +

    '           </li>' + 

    '           <li>' +
    // '             <input type="checkbox" name="remoteControlEnabled" id="vehicleCreateRemoteControl" /><span class="checkboxLabel">Vehicle can be controlled remotely<span><br>' + 
    '             <span class="checkboxLabel">Vehicle can be controlled remotely</span> ' +
    '             <div class="switch"><span class="thumb"></span><input type="checkbox" name="remoteControlEnabled" id="vehicleCreateRemoteControl"></div>' +
    '           </li>' + 
    '         </ul>' + 
    '       </form>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');

  actionBarId = id + ACTION_BAR;
  addActionBar(id, actionBarId, title, false, {
    save: true,
    saveFunction: createVehicle
  });

  // add the toggle switch to switch classed checkboxes  
  $(".switch").on("click", toggleSwitch);
}

var ACTION_BAR = 'ActionBar';

/**
 * toggleSwitch() Toggles a checkbox hidden by css.
 *
 * This is dependant on the classes switch, on and off.
 */
function toggleSwitch() {
    if (this.className === "switch on") {
      this.className = 'switch off';
    } else {
      this.className = ("switch on");
    }
    checkbox = this.lastElementChild;
    checkbox.checked = !checkbox.checked;
}

function addContentUI(id, title, subTitle) {
  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'Message" class="content">' +
    '    <div class="message">' +
    '      <div class="messageContents">' +
    '        <span>' + title + '</span><br/>' +
    '        <span>' + subTitle + '</span>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');

  actionBarId = id + ACTION_BAR;
  addActionBar(id, actionBarId, title, false);
}

function addServerContentUI(id, server) {

  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'Form" class="formContents">' +
    '    <div class="formContents">' +
    '      <div class="formContents">' +
    '       <form id="updateServerForm">' +
    '         <ul>' + 
    '           <li>' +
    '               <label>Status</label>' +
    '               <span>' + (server.isConnected ? 'Connected' : 'Disconnected') + '</span>' +
    '           </li>' + 
    '           <li>' +
    '               <label>Available vehicles</label>' +
    '               <span>' + server.nbrVehicles + '</span>' +
    '           </li>' + 
    '           <li class="breakTop">' + 
    '             <label for="serverUpdateName">Name</label>' +
    '             <input type="text" name="name" id="serverUpdateName" placeholder="Name" required><br>' +
    '           </li>' + 
    '           <li class="breakTop">' + 
    '             <label for="serverUpdateIPAddress">IP Address</label>' +
    //'             <input type="text" name="address" id="serverUpdateIPAddress" placeholder="IP Address" required pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"><br>' +
    // TODO: figure out the ip address pattern for front end validation
    '             <input type="text" name="address" id="serverUpdateIPAddress" placeholder="IP Address" required><br>' +
    '           </li>' + 
    '           <li>' + 
    '             <label for="serverUpdatePort">Port</label>' +
    '             <input type="number" min="1" max="99999" name="port" id="serverUpdatePort" placeholder="Port"><br>' +
    '           </li>' + 
    '           <li class="breakTop">' + 
    '             <label for="serverUpdateProtocol">Protocol</label>' +
    '             <input type="text" name="protocol" id="serverUpdateProtocol" placeholder="Protocol"><br>' +
    '           </li>' +
    '       </form>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');

  // set values
  $('#serverUpdateName').val(server.name);
  $('#serverUpdateIPAddress').val(server.ipAddress);
  $('#serverUpdatePort').val(server.port);
  $('#serverUpdateProtocol').val(server.protocol);
    
  actionBarId = id + 'ActionBar';

  addActionBar(id, actionBarId, server.name, false, {
    remove: true,
    removeFunction: function() {
        removeServer(server);
    },
    save: true,
    saveFunction: function() {
      updateServer(server);
    },
    disconnect: true,
    disconnectFunction: disconnectServer,
    connect: true,
    connectFunction: connectServer,
  });
}

function removeServer(server) {
  // TODO: prompt to confirm the action
  
  // set the focus to the welcome screen
  setFocus(WELCOME_CONTROL_ID, WELCOME_CONTENT_ID);
  
  // unload the ui for the server
  unloadServerUIs(server);
  
  // remove the server via the content manager
  contentManager.removeServer(server);
}

function updateServer(server) {
  // retrieve the values from the form and set to the server instance\
  var newName = $('#serverUpdateName').val();
  var nameModified = server.name !== newName;
  
  server.name = newName;
  server.ipAddress = $('#serverUpdateIPAddress').val();
  server.port = $('#serverUpdatePort').val();
  server.protocol = $('#serverUpdateProtocol').val();

  // persist the changes  
  contentManager.updateServer(server);
  
  // update the ui if the name changes
  if(nameModified) {
    var serverControlId = SERVER_CONTROL + server.position;
    
    // update the control's text to the new name
    updateControlOnSidebar(serverControlId, server.name);
    
    // update the on screen label to the new name
    $('#' + LEFT_SIDEBAR_CONTROL_TEXT + SERVER_CONTENT + server.position + ACTION_BAR).text(server.name);
  }
}

function disconnectServer() {
}

function connectServer() {
}

/*
 * addVehicleContentUI('vehicle1', 'Thunderbird 1');
 */
function addVehicleContentUI(id, vehicle) {
  vehicleContentNbr = vehicle.position;
  // addVehicleContentUI(vehicleContentId, vehicle.name, vehicleNumber);
  $('#mainApplication').append(
    '<div id="' + id + '" class="applicationContents">' +
    '  <div id="' + id + 'ContentSlider" class="contentSlider">' +
    
    '    <div class="sliderWrapper">' +
    '      <div id="' + id + PAYLOAD_SUB_ID + '" class="content" >' +
    /*
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO PAYLOAD FOUND</span><br/>' +
    '            <span>You can add payload monitors via settings</span>' +
    '          </div>' +
    '        </div>' +
    */
    '        <div id="payloadMap" class="map">' +
    '        </div>' +
    
    '      </div>' +
    '      <div id="' + id + TELEMETRY_SUB_ID + '" class="content">' +
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO TELEMETRY FOUND</span><br/>' +
    '            <span>You can add telemetry gauges via settings</span>' +
    '          </div>' +
    '        </div>' +
    /*
    '        <div id="toolbarControl" class="toolbarControl">' +
    '            <div id="toolbar" class="toolbar">' +
    '              <!-- controls are currently added here when the document is loaded, see loadToolbar() -->' +
    '            </div>' +
    '            <div id="toolbarAccess" class="toolbarAccess">' +
    '                <div id="toolbarButtonImage" class="toolbarAccessBar toolbarAccessBarInactive">' +
    '                </div>' +
    '            </div>' +
    '        </div>' +
    */
    '      </div>' +
    '      <div id="' + id + FLIGHTPLAN_SUB_ID + '" class="content">' +
    /*
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO NAVIGATION FOUND</span><br/>' +
    '            <span>You can configure navigation options via settings</span>' +
    '          </div>' +
    '        </div>' +
    */
    '        <div id="flightPlanMap" class="map">' +
    '        </div>' +
    '      </div>' +
    '      <div id="' + id + REMOTECONTROL_SUB_ID + '" class="content">' +
    '        <div class="message">' +
    '          <div class="messageContents">' +
    '            <span>NO REMOTE CONTROL FOUND</span><br/>' +
    '            <span>The selected vehicle is not configured for remote control</span>' +
    '          </div>' +
    '        </div>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>');
  
  // setup the map
  
  // TODO: tidy up the mapping logic
  
  var mapquestOsmTileUrl = 'http://otile{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',
      mapquestOsmAttribution = "Data CC-By-SA by <a href='http://openstreetmap.org/' target='_blank'>OpenStreetMap</a>, Tiles Courtesy of <a href='http://open.mapquest.com' target='_blank'>MapQuest</a>";

  var mapquestOpenAerialTileUrl = 'http://otile{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png',
      mapquestOpenAerialAttribution = "Data CC-By-SA by <a href='http://openstreetmap.org/' target='_blank'>OpenStreetMap</a>, Tiles Courtesy of <a href='http://open.mapquest.com' target='_blank'>MapQuest</a>, Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency";

  var opencyclemapLandscapeUrl = 'http://{s}.tile3.opencyclemap.org/landscape/{z}/{x}/{y}.png',
      opencyclemapLandscapeAttribution = '&copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
      
      
  var esriWorldTopographicalUrl = 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
      esriWorldTopographicalAttribution = 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community';
  
  var esriWorldImageryUrl = 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      esriWorldImageryAttribution = 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';

  var esriWorldImageryTileLayer = new L.TileLayer(esriWorldImageryUrl, {maxZoom: 18, attribution: esriWorldImageryAttribution,subdomains: ['1', '2', '3', '4']});
  var esriWorldTopographicalTileLayer = new L.TileLayer(esriWorldTopographicalUrl, {maxZoom: 18, attribution: esriWorldTopographicalAttribution,subdomains: ['1', '2', '3', '4']});

  var flightPlanTileLayer = new L.TileLayer(mapquestOsmTileUrl, {
    maxZoom: 18,
    attribution: mapquestOsmAttribution,
    subdomains: ['1', '2', '3', '4']
  });
  var flightPlanSatTileLayer = new L.TileLayer(mapquestOpenAerialTileUrl, {
    maxZoom: 18,
    attribution: mapquestOpenAerialAttribution,
    subdomains: ['1', '2', '3', '4']
  });
  
  var cloudmadeTilesUrl = 'http://{s}.tile.cloudmade.com/21AE2933E8054FF8b90A537357289E78/{styleId}/256/{z}/{x}/{y}.png',
      cloudmadeAttribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade';

  var minimal   = L.tileLayer(cloudmadeTilesUrl, {styleId: 22677, attribution: cloudmadeAttribution}),
    fresh  = L.tileLayer(cloudmadeTilesUrl, {styleId: 997, attribution: cloudmadeAttribution}),
    midnightCommander  = L.tileLayer(cloudmadeTilesUrl, {styleId: 999, attribution: cloudmadeAttribution}),
    nightVision  = L.tileLayer(cloudmadeTilesUrl, {styleId: 78125, attribution: cloudmadeAttribution}),
    minimalMarkers = L.tileLayer(cloudmadeTilesUrl, {styleId: 63044, attribution: cloudmadeAttribution});
//    motorways = L.tileLayer(cloudmadeTilesUrl, {styleId: 46561, attribution: cloudmadeAttribution});

  // set the default image path for te icon
  L.Icon.Default.imagePath = 'assets/img/';
    
  var flightPlanMap = new L.Map('flightPlanMap', {
    center: new L.LatLng(-27.632600, 153.146466),
    zoom: 16,
    layers: [flightPlanTileLayer, flightPlanSatTileLayer, esriWorldImageryTileLayer, esriWorldTopographicalTileLayer],
    zoomControl: false
  });

  var flightPlanBaseLayers = {
    "Map Quest Street": flightPlanTileLayer,
    "Map Quest Satelite": flightPlanSatTileLayer,
    "ESRI World Imagery": esriWorldImageryTileLayer,
    "ESRI World Topographical": esriWorldTopographicalTileLayer
  };
  
  L.control.layers(flightPlanBaseLayers).addTo(flightPlanMap);
  
  // setup the map
  var payloadMap = new L.Map('payloadMap', {
    center: [39.73, -104.99],
    zoom: 10,
    layers: [minimal],
    zoomControl: false
  });
  
  L.control.scale().addTo(payloadMap);
  
  var baseLayers = {
    "Fresh": fresh,
    "Minimal": minimal,
    "Minimal 2": minimalMarkers,
    "Night Vision": nightVision,
    "Night View": midnightCommander
  };

  L.control.layers(baseLayers).addTo(payloadMap);

  payloadMap.panTo(new L.LatLng(-27.47718, 153.02712));
  payloadMap.addLayer(nightVision);

  var circle = L.circle([-27.62499, 153.16169], 50, {
    color: 'blue',
    fillColor: '#f03',
    fillOpacity: 0.5,
  }).addTo(payloadMap);

  // setup the initial points
  // TODO: this should be loaded, uncertain where from...
  var flightPathPoints = new Array(
    [-27.62531, 153.14351],
    [-27.61957, 153.15287],
    [-27.62499, 153.16169],
    [-27.63523, 153.16038],
    [-27.63252, 153.14302]);
  
  // create the flight path polyline
  var flightPathPolyLine = L.polyline(flightPathPoints, {color: 'blue'}).addTo(payloadMap);
  
  var markerDragged = function (i) {
    return function(e) {
      newPoint = e.target.getLatLng();
      flightPathPoints[i].lat = newPoint.lat;
      flightPathPoints[i].lng = newPoint.lng;
      
      flightPathPolyLine.setLatLngs(flightPathPoints);
    }
  }
  
  // iterate through the array and add a marker for each point
  // TODO: special marker for special events, or for landing/takeoff?
  for(var i=0, l=flightPathPoints.length; i < l; i++) {
    L.marker(flightPathPoints[i], { draggable: true, opacity: 0.5}).addTo(payloadMap).on('drag', markerDragged(i));
  }
  
  var popup1 = L.popup();
  var popup2 = L.popup();

  function onPayloadMapMapClick(e) {
      popup1
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(payloadMap);
  }
  function onFlightPlanMapClick(e) {
      popup2
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(flightPlanMap);
  }
  
  payloadMap.on('click', onPayloadMapMapClick);
  flightPlanMap.on('click', onFlightPlanMapClick);
  
  // add the pane to the tab manager
  contentManager.addPane(id);
  
  // setup the settings for the payload
  var payloadSettings = new TabSettings();
  payloadSettings.add(new HeadingSetting('some stuff'));
  payloadSettings.add(new ToggleSetting(id  + PAYLOAD_SUB_ID + 'Graph', 'Graph'));
  payloadSettings.add(new TextSetting(id  + PAYLOAD_SUB_ID + 'Timeout', 'Timeout'));
  
  // setup the telemetry settings  
  var telemetrySettings = new TabSettings();
  var gaugeSetting;
  
  // TODO: should be populated 
  telemetrySettings.add(new HeadingSetting('some stuff'));
  telemetrySettings.add(new ToggleSetting(id  + TELEMETRY_SUB_ID + 'Graph', 'Graph'));
  telemetrySettings.add(new TextSetting(id  + TELEMETRY_SUB_ID + 'Timeout', 'Timeout'));
  telemetrySettings.add(new HeadingSetting('Gauges'));

  // TODO: should this be here or outside this function scope?
  function addGaugeToContentAreaSettings(contentAreaId, tabSettings, gaugeSetting) {
    tabSettings.add(gaugeSetting);
    
    if(gaugeSetting.visible) {
      showGauge(gaugeSetting, contentAreaId);
    }
  }
  
  // TODO: settings are to be persisted, change so that they're restored... 
  addGaugeToContentAreaSettings(id  + TELEMETRY_SUB_ID, telemetrySettings, new GaugeSetting(id  + TELEMETRY_SUB_ID + 'SpeadGauge', speedGauge, {x: 0, y: 0, width: 150, visible: true}));
  addGaugeToContentAreaSettings(id  + TELEMETRY_SUB_ID, telemetrySettings, new GaugeSetting(id  + TELEMETRY_SUB_ID + 'AttitudeGauge', attitudeGauge, {x: 150, y: 0, width: 150, visible: true}));
  addGaugeToContentAreaSettings(id  + TELEMETRY_SUB_ID, telemetrySettings, new GaugeSetting(id  + TELEMETRY_SUB_ID + 'AltimeterGauge', altimeterGauge, {x: 300, y: 0, width: 150, visible: true}));
  addGaugeToContentAreaSettings(id  + TELEMETRY_SUB_ID, telemetrySettings, new GaugeSetting(id  + TELEMETRY_SUB_ID + 'ThermometerGauge', thermometerGauge, {x: 0, y: 150, width: 150, visible: false}));
  addGaugeToContentAreaSettings(id  + TELEMETRY_SUB_ID, telemetrySettings, new GaugeSetting(id  + TELEMETRY_SUB_ID + 'HeadingGauge', headingGauge, {x: 150, y: 150, width: 150, visible: true}));
  addGaugeToContentAreaSettings(id  + TELEMETRY_SUB_ID, telemetrySettings, new GaugeSetting(id  + TELEMETRY_SUB_ID + 'VSIGauge', vsiGauge, {x: 300, y: 150, width: 150, visible: false}));

  // setup the navigation settings  
  var navigationSettings = new TabSettings();
  navigationSettings.add(new HeadingSetting('some stuff'));
  
  // setup the remote control settings
  var remoteControlSettings = new TabSettings();
  remoteControlSettings.add(new HeadingSetting('some stuff'));
  
  // add the action bar and the tabs within the action bar
  actionBarId = id + 'ActionBar';
  addActionBar(id, actionBarId, vehicle.name, true);
  addTabToActionBar(actionBarId, id, id  + PAYLOAD_TAB_CONTROL, 'Payload', PAYLOAD_TAB, vehicle.position, true);
  contentManager.addTab(id, id  + PAYLOAD_SUB_ID, payloadSettings);
  addDividerToActionBar(actionBarId);
  addTabToActionBar(actionBarId, id, id + TELEMETRY_TAB_CONTROL, 'Telemetry', TELEMETY_TAB, vehicle.position);
  contentManager.addTab(id, id  + TELEMETRY_SUB_ID, telemetrySettings);
  addDividerToActionBar(actionBarId);
  addTabToActionBar(actionBarId, id, id + FLIGHTPLAN_TAB_CONTROL, 'Navigation', FLIGHT_PLAN_TAB, vehicle.position);
  contentManager.addTab(id, id  + FLIGHTPLAN_SUB_ID, navigationSettings);
  addDividerToActionBar(actionBarId);
  addTabToActionBar(actionBarId, id, id + REMOTECONTROL_TAB_CONTROL, 'Remote Control', REMOTE_CONTROL_TAB, vehicle.position);
  contentManager.addTab(id, id  + REMOTECONTROL_SUB_ID, remoteControlSettings);
  
  // set the tab manager for this panel to the first tab (which is the selected tab)
  // todo: should this be PAYLOAD_SUB_ID and not PAYLOAD_TAB_CONTROL?
  contentManager.setFocusedTabNbr(id, 0);
  contentManager.setFocusedTabId(id, id  + PAYLOAD_SUB_ID);
  
  /* TODO: appears removing the callback and adding slideCallback worked, but requires futher testing when
   * the issues with side bar navigation are sorted out
   */
  // setup the swipe using Slider for the vehicle content
  
  vehicleContentSlider[vehicle.position] = new Swipe(document.getElementById(id + 'ContentSlider'), {
//      callback: function(e, position) { contentTabChanged(e, position, id); },
      slideCallback: function(position) { contentTabChanged('', position, id, vehicle.position); },
      slideEffect: 'android'
    });
}

function removeVehicle(vehicle) {
  // TODO: prompt to confirm the action
  
  // set the focus to the welcome screen
  setFocus(WELCOME_CONTROL_ID, WELCOME_CONTENT_ID);
  
  // unload the ui for the server
  unloadVehicleUIs(vehicle);
  
  // remove the vehicle via the content manager
  contentManager.removeVehicle(vehicle);
}

/*
 * add a control to the sidebar, before the specified id
 */
function addControlToSidebarBeforeId(beforeId, id, icon, name) {
  $('#' + beforeId).before(
    '<div id="' + id + '" class="sidebarControlBar">' +
    '  <div class="sidebarControlIcon"><img src="' + icon + '" class="sidebarControlIcon"/></div>' +
    '  <div id="' + id + 'Name" class="sidebarControlText centered">' + name + '</div>' +
    '</div>');
}

function updateControlOnSidebar(id, name) {
  $('#' + id + 'Name').text(name);
}

function appendControlToSidebar(groupId, id, icon, name) {
  $('#' + groupId).append(
    '<div id="' + id + '" class="sidebarControlBar">' +
    '  <div class="sidebarControlIcon"><img src="' + icon + '" class="sidebarControlIcon"/></div>' +
    '  <div class="sidebarControlText centered">' + name + '</div>' +
    '</div>');
}

var deletePreviousContent = false;
var previousContentId;

function addListenerToSidebarControl(sidebarId, controlId, paneId, contentLoadFunction) {
  $('#' + controlId).click(function() {
    // if reselecting the same then nothing to do other than hide the sidebar
    if(paneId !== previousContentId) {
    
      // if the previous content is deletable then delete it
      if(deletePreviousContent) {
        $('#' + previousContentId).remove();
      }
      
      previousContentId = paneId;
      deletePreviousContent = false;
      
      // if the contentLoadFunction is defined then execute it to load the content
      if(typeof contentLoadFunction !== 'undefined') {
        contentLoadFunction();
        deletePreviousContent = true;
      }
  
      // set the focus, which switches the view to the content
      setFocus(controlId, paneId);
    }
    
    // hide the sidebar as it is hidden when a content selection is made
    hideSidebar(sidebarId, 'mainApplication', 'mainApplicationOverlay', '300ms');
  });
}

function contentTabChanged(e, position, id, contentNbr) {
  // turn off the currently selected tab
  switch(contentManager.getFocusedTabNbr(id)) {
    case PAYLOAD_TAB:
      $('#' + id + PAYLOAD_TAB_CONTROL).toggleClass('tabSelected');
      break;
    case TELEMETY_TAB:
      $('#' + id + TELEMETRY_TAB_CONTROL).toggleClass('tabSelected');
      break;
    case FLIGHT_PLAN_TAB:
      $('#' + id + FLIGHTPLAN_TAB_CONTROL).toggleClass('tabSelected');
      break;
    case REMOTE_CONTROL_TAB:
      $('#' + id + REMOTECONTROL_TAB_CONTROL).toggleClass('tabSelected');
      break;
  }
  
  // todo: remove following as replaced by contentManager
  // vehicleTabSelection[contentNbr] = position;
  contentManager.setFocusedTabNbr(id, position);
  
  // turn on the new tab
  switch (position) {
    case PAYLOAD_TAB:
      $('#' + id + PAYLOAD_TAB_CONTROL).toggleClass('tabSelected');
      contentManager.setFocusedTabId(id, id + PAYLOAD_SUB_ID);
      break;
    case TELEMETY_TAB:
      $('#' + id + TELEMETRY_TAB_CONTROL).toggleClass('tabSelected');
      contentManager.setFocusedTabId(id, id + TELEMETRY_SUB_ID);
      break;
    case FLIGHT_PLAN_TAB:
      $('#' + id + FLIGHTPLAN_TAB_CONTROL).toggleClass('tabSelected');
      contentManager.setFocusedTabId(id, id + FLIGHTPLAN_SUB_ID);
      break;
    case REMOTE_CONTROL_TAB:
      $('#' + id + REMOTECONTROL_TAB_CONTROL).toggleClass('tabSelected');
      contentManager.setFocusedTabId(id, id + REMOTECONTROL_SUB_ID);
      break;
  }
}

function setFocus(controlId, paneId) {
  // if the current focus is the selected focus then no need to do anything
  if(contentManager.focusedPaneId == paneId) {
    return;
  }
  
  // turn off the control for the current focus, if set
  if(currentFocusControlId != '') {
    $('#' + currentFocusControlId).toggleClass('sidebarControlActive');
  }
  
  // turn on the control for the set focus
  $('#' + controlId).toggleClass('sidebarControlActive');
  
  // update the focus to the set focus
  currentFocusControlId = controlId;
  
  // display the selected content before hiding, so no flickering white stuff
  $('#' + paneId).css('visibility', 'visible');

  // update the visbility of the previously focused pane  
  if(contentManager.focusedPaneId != '') {
    $('#' + contentManager.focusedPaneId).css('visibility', 'hidden');
  }
  
  // set the content manager to the newly focused pane
  contentManager.focusedPaneId = paneId;
}

/*
 *
 * showSidebar('rightSidebar', 'right', 'mainApplication', 'mainApplicationOverlay', 'mainApplicationOverlay', '300ms')
 * showSidebar(LEFT_SIDEBAR_ID, 'left', 'mainApplication', 'mainApplicationOverlay', 'mainApplicationOverlay', '300ms')
 * 
 */
function showSidebar(sidebarId, location, mainPanelId, overlayPanelId, overlayPanelCSS, time) {
  var mainPanel = $('#' + mainPanelId);
  var width = $('#' + sidebarId).width();
  var overlayPanel = $('#' + overlayPanelId);
  
  // determine the x adjustment based on the location of the side bar
  // we move negative if the side bar is right, positive if the side bar is left
  var x = location == 'right' ? width * -1 : width;
  
  if (mainPanel.length > 0) {
    // check if the overlay div exists, if not then create it
    // TODO: determine if the overlay div should always exist and remove this logic to add it
    if (overlayPanel.length <= 0) {
      // create a div to overlay the main application
      // this is to capture presses/clicks so as to restore the main application
          
      $(document.body).append('<div ' + 'id="' + overlayPanelId + '" class="' + overlayPanelCSS + '" ></div>');

      // just created it, so set the var      
      overlayPanel = $('#' + overlayPanelId);
    }

    overlayPanel.off('click');
    // setup listener to restore main application
    overlayPanel.on('click', function () { hideSidebar(sidebarId, mainPanelId, overlayPanelId, time) });
    
    overlayPanel.css('right', '');
    overlayPanel.css('left', '');
    overlayPanel.css(location, width + 'px');
    
    mainPanel.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    mainPanel.css('-moz-transition', 'all ' + time + ' ease-in-out');
    mainPanel.css('-o-transition', 'all ' + time + ' ease-in-out');
    mainPanel.css('transition', 'all ' + time + ' ease-in-out');

    // listen to the end of the transition so the z-index can be updated
    mainPanel.bind("webkitTransitionEnd oTransitionEnd transitionend msTransitionEnd", function(){
      // at the end of the transformation, change the z-index of the side panel to a high value so
      // there are no problems with slide scrolling stuff
      $('#' + sidebarId).css('z-index', 200);

      // remove the transition
      mainPanel.unbind("webkitTransitionEnd oTransitionEnd transitionend msTransitionEnd");
    });    
    
    mainPanel.css('-webkit-transform', 'translate(' + x + 'px, 0px)');
    mainPanel.css('-moz-transform', 'translate(' + x + 'px, 0px)');
    mainPanel.css('-o-transform', 'translate(' + x + 'px, 0px)');
    mainPanel.css('transform', 'translate(' + x + 'px, 0px)');

    /*
     * TODO: check if the overlay div should be animated at the same time as the main application
     * if we don't do this, it may be possible that a person tries to abort the showing of the side
     * panel by pressing/clicking on the content but it wont work due to how it doesn't cover
     * everywhere yet...
     */
    
    // make the overlay div active by making it visible
    $('#' + overlayPanelId).css('visibility', 'visible');
  }
}

/*
 *
 * hideSidebar('mainApplication', 'mainApplicationOverlay', '300ms')
 * showSidebar('mainApplication', 'mainApplicationOverlay', '300ms')
 * 
 */
function hideSidebar(sidebarId, mainPanelId, overlayPanelId, time) {
  var mainPanel = $('#' + mainPanelId);
  
  if (mainPanel.length > 0) {
    // make the overlay div inactive by making it invisible
    $('#' + overlayPanelId).css('visibility', 'hidden');
    
    // clear the z-index setting for the side bar    
    $('#' + sidebarId).css('z-index', '');

    // transform the main panel back into position    
    mainPanel.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    mainPanel.css('-moz-transition', 'all ' + time + ' ease-in-out');
    mainPanel.css('-o-transition', 'all ' + time + ' ease-in-out');
    mainPanel.css('transition', 'all ' + time + ' ease-in-out');

    mainPanel.css('-webkit-transform', 'translate(0px, 0px)');
    mainPanel.css('-moz-transform', 'translate(0px, 0px)');
    mainPanel.css('-o-transform', 'translate(0px, 0px)');
    mainPanel.css('transform', 'translate(0px, 0px)');
  }
}

// define gauges
var videoGauge = new Gauge({name: 'video', title: 'Video', description: 'Live video feed',
				 icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_video.png',
				 contentIsCanvas: true});
var speedGauge = new Gauge({name: 'speed', title: 'Speed', description: 'Relative to surounding air',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/speed_background_s.png',
			         needleImg1: 'assets/gauges/speed_needle_s.png',
			         foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
			         });
var attitudeGauge = new Gauge({name: 'attitude', title: 'Attitude', description: 'Orientation aroud the center of mass',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         overlayImg: 'assets/gauges/attitude_foreground_s.png',
			         foregroundImg: 'assets/gauges/gauge_base_plate_s.png',
				 foregroundClips: true,
			         needleImg1: 'assets/gauges/attitude_horizon_s.png',
				 needleImg1Rotates: true,
				 needleImg1VerticalScroll: true,
				 needleImg1VerticalScrollType: 'relative',
				 needleImg1XOffset: '-161px',
				 needleImg1Height: '830px',
			         needleImg2: 'assets/gauges/attitude_needle_s.png',
				 mask: 'assets/gauges/gauge_base_mask_s.png'
			         });
var altimeterGauge = new Gauge({name: 'altimeter', title: 'Altimeter', description: 'Altitude above mean sea level',
			          icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/altimeter_background_s.png',
			         needleImg1: 'assets/gauges/altimeter_large_needle_s.png',
			         needleImg2: 'assets/gauges/altimeter_small_needle_s.png',
			         foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
			         });

var headingGauge = new Gauge({name: 'heading', title: 'Heading', description: 'Direction in respect to magnetic north',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_compass.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/compass_background_s.png',
			         needleImg1: 'assets/gauges/compass_needle_s.png'
			         });
				
var vsiGauge = new Gauge({name: 'vsi', title: 'VSI', description: 'Vertical speed indicator',
			         icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
			         dialImg: 'assets/gauges/vsi_background_s.png',
			         needleImg1: 'assets/gauges/vsi_needle_s.png',
			         foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
			         });
				
var thermometerGauge = new Gauge({name: 'thermometer', title: 'Thermometer', description: 'Engine tempurature',
				 icon: 'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',
			         backgroundImg: 'assets/gauges/gauge_base_s.png',
				 dialImg: 'assets/gauges/thermometer_background_s.png',
				 needleImg1: 'assets/gauges/thermometer_needle_s.png',
				 foregroundImg: 'assets/gauges/gauge_needle_cap_s.png'
				 });

/*
 * setGaugeAngle()
 *
 * example:
 *
  // angle was calculated roughly from image, may need adjustment
  var degree = 1.615;
  var value = 1.615 * 100;
 * setInstrument('speed', 'needle', myWidgetAngle, 45, '200ms')
 */
function setGaugeAngle(gaugeId, gauge, indicatorName, degree, time) {
  // lets play with the speed
  var currentAngle = 0; 
  var direction = 1;  // default positive

  var obj = $('#instrument' + gaugeId + '_' + indicatorName);

  if (obj.length > 0) {
    obj.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    obj.css('-moz-transition', 'all ' + time + ' ease-in-out');
    obj.css('-o-transition', 'all ' + time + ' ease-in-out');
    obj.css('transition', 'all ' + time + ' ease-in-out');

    origin = '50% 50%';
    obj.css('-webkit-transform-origin', origin);
    obj.css('-moz-transform-origin', origin);
    obj.css('-o-transform-origin', origin);
    obj.css('transform-origin', origin);

    
    obj.css('-webkit-transform', 'rotate(' + degree + 'deg)');
    obj.css('-moz-transform', 'rotate(' + degree + 'deg)');
    obj.css('-o-transform', 'rotate(' + degree + 'deg)');
    obj.css('transform', 'rotate(' + degree + 'deg)');
  }
}

function setGauge(gaugeId, gauge, indicatorName, degree, value, time) {
  // lets play with the speed
  var currentAngle = 0; 
  var direction = 1;  // default positive

  var obj = $('#instrument' + gaugeId + '_' + indicatorName);

  if (obj.length > 0) {
    obj.css('-webkit-transition', 'all ' + time + ' ease-in-out');
    obj.css('-moz-transition', 'all ' + time + ' ease-in-out');
    obj.css('-o-transition', 'all ' + time + ' ease-in-out');
    obj.css('transition', 'all ' + time + ' ease-in-out');

    origin = '50% 50%';
    obj.css('-webkit-transform-origin', origin);
    obj.css('-moz-transform-origin', origin);
    obj.css('-o-transform-origin', origin);
    obj.css('transform-origin', origin);

    
    obj.css('-webkit-transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
    obj.css('-moz-transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
    obj.css('-o-transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
    obj.css('transform', 'rotate(' + degree + 'deg) translate(0px, ' + value + ')');
  }
}

function enableHal() {
  halEnabled = true;

  //TODO: need the id to set the gauge
  // lets play with the direction
  setGaugeAngle('gaugeId', headingGauge, 'needle1', 176, '2s');
  setGaugeAngle('gaugeId', thermometerGauge, 'needle1', 90, '750ms');
  setGaugeAngle('gaugeId', vsiGauge, 'needle1', 98, '1s');
  setGaugeAngle('gaugeId', altimeterGauge, 'needle1', 45, '1s');
  setGaugeAngle('gaugeId', altimeterGauge, 'needle2', 36, '1s');
  setGaugeAngle('gaugeId', speedGauge, 'needle1', 45, '500ms');

  setGaugeAngle('gaugeId', attitudeGauge, 'needle2', 45, '750ms');
  setGauge('gaugeId', attitudeGauge, 'needle1', 45, '25px', '750ms');
  
  performVideoCountdown(videoGauge);
}

function disableHal() {
  halEnabled = false;

  setGaugeAngle('gaugeId', headingGauge, 'needle1', 0, '500ms');
  setGaugeAngle('gaugeId', thermometerGauge, 'needle1', 0, '300ms');
  setGaugeAngle('gaugeId', vsiGauge, 'needle1', 0, '300ms');
  setGaugeAngle('gaugeId', altimeterGauge, 'needle1', 0, '300ms');
  setGaugeAngle('gaugeId', altimeterGauge, 'needle2', 0, '300ms');
  setGaugeAngle('gaugeId', speedGauge, 'needle1', 0, '300ms');

  setGaugeAngle('gaugeId', attitudeGauge, 'needle2', -45, '750ms');
  setGauge('gaugeId', attitudeGauge, 'needle1', -45, '-25px', '750ms');
  
}

function initialiseVideoCountdown(gauge) {
}

function performVideoCountdown(gauge) {
  canvas = document.getElementById(gauge.canvasId);
  ctx = canvas.getContext('2d');
  canvas_size = [canvas.width, canvas.height];
  radius = Math.min(canvas_size[0], canvas_size[1]) / 2;
  center = [canvas_size[0]/2, canvas_size[1]/2];
  start = 1;
  fps = 40;
  seconds = 2;
  
  var total = fps*seconds;
  
  for(var i=total;i>=0;i--) {
    var delayed = (function(){
      var step = 1-i/total;
      var left = Math.ceil(i/fps);
      
      return function() {
	// num.innerHTML=left;
	draw_next(step);
      };
    })();
    
    setTimeout(delayed, -1000 / fps * (i-total));
  }
}

function draw_next(step) { // step between 0 and 1
  ctx.clearRect(0,0,canvas_size[0], canvas_size[1]);
  
  if(step < 1) {
    ctx.beginPath();
    ctx.moveTo(center[0], center[1]); // ponto central
    
    ctx.arc(  // draw next arc
      center[0],
      center[1],
      radius,
      Math.PI * (-0.5 + 0), // -0.5 pra começar do topo
      Math.PI * (-0.5 + step*2),
      true // anti horário
      );
    
    ctx.lineTo(center[0], center[1]); // line back to the center
    ctx.closePath();
    
    ctx.fillStyle = 'rgb(40,40,40)';    // color
    
    ctx.fill();
  }
}

				 
/*
 * loadToolbar - loads the toolbar
 */
function loadToolbar() {
  // TODO: determine how to handle adding a control for a gauge vs a non gauge toggling control. maybe seperate methods?
  /**
   * for (var i=0; i < obj.length; i++) {
    
   }
   */
  /*
   * TODO: maybe define a control that is icon, title and name, or is that redundant when it's incorporated into the Gauge?
   * maybe the title and description should be removed from Gauge and added to a new type called Control.... Then the control
   * could be linked to the gauge so it knows what it controls... 
   */
  
  // TODO: load this information from remote source or from local storage...
  
  addControlToToolbar('toolbar', 'toggleConnection',  'assets/icons/drawable-xhdpi-v11/ic_stat_power.png',   'Connection',  'Connectivity to the vehicle');
  addControlToToolbar('toolbar', 'toggleHal',         'assets/icons/drawable-xhdpi-v11/ic_stat_gauge.png',   'Hal 9000',    'Test to control guages');
  
  addControlToToolbar('toolbar', 'toggle' + videoGauge.name, videoGauge.icon, videoGauge.title, videoGauge.description);

  addControlToToolbar('toolbar', 'toggle' + speedGauge.name, speedGauge.icon, speedGauge.title, speedGauge.description);
  addControlToToolbar('toolbar', 'toggle' + attitudeGauge.name, attitudeGauge.icon, attitudeGauge.title, attitudeGauge.description);
  addControlToToolbar('toolbar', 'toggle' + altimeterGauge.name, altimeterGauge.icon, altimeterGauge.title, altimeterGauge.description);
  addControlToToolbar('toolbar', 'toggle' + headingGauge.name, headingGauge.icon, headingGauge.title, headingGauge.description);
  addControlToToolbar('toolbar', 'toggle' + vsiGauge.name, vsiGauge.icon, vsiGauge.title, vsiGauge.description);
  addControlToToolbar('toolbar', 'toggle' + thermometerGauge.name, thermometerGauge.icon, thermometerGauge.title, thermometerGauge.description);

  $('#toggleConnection').click(function() {
    if(connected) {
      disconnect();
    } else {
      connect();
    }
    return false;
  });

  $('#toggleHal').click(function() {
    if(halEnabled) {
      disableHal();
      $('#toggleHal' + 'ControlArea').toggleClass('controlIconAreaSelected');
    } else {
      enableHal();
      $('#toggleHal' + 'ControlArea').toggleClass('controlIconAreaSelected');
    }
    return false;
  });

  // define the function for toggling the gauge control
  var toggleGaugeFn = function(gauge) {
    if(gauge.enabled) {
      gauge.enabled = !hideGauge(gauge.id);
      $('#toggle' + gauge.name + 'ControlArea').toggleClass('controlIconAreaSelected');
    } else {
      gauge.enabled = showGauge(gauge);
      $('#toggle'  + gauge.name + 'ControlArea').toggleClass('controlIconAreaSelected');
    }
    return false;
  }
  
  $('#toggle' + videoGauge.name).click(function() {toggleGaugeFn(videoGauge)});
  $('#toggle' + speedGauge.name).click(function() {toggleGaugeFn(speedGauge)});
  $('#toggle' + attitudeGauge.name).click(function() {toggleGaugeFn(attitudeGauge)});
  $('#toggle' + altimeterGauge.name).click(function() {toggleGaugeFn(altimeterGauge)});
  $('#toggle' + headingGauge.name).click(function() {toggleGaugeFn(headingGauge)});
  $('#toggle' + vsiGauge.name).click(function() {toggleGaugeFn(vsiGauge)});
  $('#toggle' + thermometerGauge.name).click(function() {toggleGaugeFn(thermometerGauge)});
}

/*
 * addControlToToolbar - adds a new control entry to the toolbar
 *
 * parentid the parent that the control will be added to
 * id       the id for the control
 * icon     the icon representing the gaugue
 * name     the name of the control
 * subText  a description of the control
 */

function addControlToToolbar(parentId, id, icon, name, subText) {
  $('#' + parentId).append(
    '<div id="' + id + '" class="controlBar">' +
    '  <div id="' + id + 'ControlArea" class="controlIconArea">' +
    '    <img class="controlIcon" src="' + icon + '" />' +
    '  </div>' +
    '  <div class="controlText">' +
    '    <div class="controlName">' +
           name + 
    '    </div>' +
    '    <div class="controlSubText">' +
           subText + 
    '    </div>' +
    '  </div>' +
    /*
    '  <div class="controlToggle">' +
    '    <img class="controlToggleImage" src="assets/icons/drawable-xhdpi-v11/ic_stat_unlocked.png" />' +
    '  </div>' +
    '  <div class="controlToggle">' +
    '    <img class="controlToggleImage" src="assets/icons/drawable-xhdpi-v11/ic_stat_hidden.png" />' +
    '  </div>' +
    */
    '</div>');
}
/* jgj TODO: is this still required?
var toolbarHidden = true;

function toolbarDisplay(direction, phase, distance) {
  // it is apparent that the start phase often doesn't have direction
  
  switch(phase) {
    case "start":   // swipe has started
      if(toolbarHidden) {
        // make bar active
        $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');

	// TODO: change the +/- to use the size from css
	
        // animate bar
        $('#toolbarControl').animate({
          'right': '+=250px'
        }, 300, function() {
          $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');
          toolbarHidden = false;
        });
      } else {
        $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');
        
        $('#toolbarControl').animate({
          'right': '-=250px'
        }, 300, function() {
          $('#toolbarAccessBar').toggleClass('toolbarAccessBarActive');
          toolbarHidden = true;
        });
      }
      break;
      
    case "cancel":  // swipe has been cancelled (didn't travel far enough)
      break;
    
    case "end":     // swipe is successful
      break;
      
    case "move":    // swipe is moving
      break;
    
  }
}
*/
/*
 * showGauge() displays a panel, creating it if it doesn't exist
 * 
 * gauge - the gauge to display
 *
 * returns true if the panel is sucessfully displayed
 */
function showGauge(gaugeSetting, parentId) {
  // default values
  /* TODO: add in x, y so as to be able to set where it is when displaying for the first time
  panelWidth = (typeof optionalArg === "undefined") ? '100%' : panelWidth;
  panelHeight = (typeof optionalArg === "undefined") ? '100%' : panelHeight;
  x = (typeof optionalArg === "undefined") ? '100px' : x;
  y = (typeof optionalArg === "undefined") ? '100px' : y;
  */
  
  // if the panel doesn't exist then add it
  if ($('#' + gaugeSetting.gaugeId).length <= 0) {
    // create the div with the appropriate images
			    
    // NOTE: when not using img to load the svg, need to overlay a transparent div so drag'n'drop will still work, don't really need it here
    // TODO: check removing the drag div
    
    var gaugeHTML = '';

    gaugeHTML +=
      '<div ' + 'id="' + gaugeSetting.gaugeId + '" class="viewPanel">';
    
    if(gaugeSetting.gauge.contentIsCanvas) {
      gaugeHTML +=
	'<canvas id="canvas' + gaugeSetting.gaugeId + '" class="gaugeOverlay" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" >no Canvas for you</canvas>';
    } else {
      // some gauges may not have a background
      if(typeof gaugeSetting.gauge.backgroundImg != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gaugeSetting.gaugeId + '_background" class="gaugeOverlay gaugeBackground" src="' + gaugeSetting.gauge.backgroundImg + '" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" />';
      }

      // add the dial image
      if(typeof gaugeSetting.gauge.dialImg != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gaugeSetting.gaugeId + '_dial" class="gaugeOverlay gaugeBackground" src="' + gaugeSetting.gauge.dialImg + '" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" />';
      }
  
      // if the first needle is specified, then set
      if(typeof gaugeSetting.gauge.needleImg1 != "undefined") {
	if(typeof gaugeSetting.gauge.needleImg1XOffset != "undefined") {
	gaugeHTML += 
	//'<img id="instrument' + gauge.name + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg1    + '" width="' + gauge.width + '" height="' + gauge.needleImg1Height + '" />';
	'<img id="instrument' + gaugeSetting.gaugeId + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gaugeSetting.gauge.needleImg1    + '" width="' + gaugeSetting.gauge.width + '" style="top: ' + gaugeSetting.gauge.needleImg1XOffset + '"/>';
	} else {
	gaugeHTML += 
	//'<img id="instrument' + gauge.name + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gauge.needleImg1    + '" width="' + gauge.width + '" height="' + gauge.needleImg1Height + '" />';
	'<img id="instrument' + gaugeSetting.gaugeId + '_needle1"    class="gaugeOverlay gaugeNeedle"     src="' + gaugeSetting.gauge.needleImg1    + '" width="' + gaugeSetting.gauge.width + '" />';
	}
      }
	
      // if the second needle is specified, then set
      if(typeof gaugeSetting.gauge.needleImg2 != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gaugeSetting.gaugeId + '_needle2"    class="gaugeOverlay gaugeNeedle"     src="' + gaugeSetting.gauge.needleImg2    + '" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" />';
      }
	
      // if the third needle is specified, then set
      if(typeof gaugeSetting.gauge.needleImg3 != "undefined") {
	gaugeHTML += 
	'<img id="instrument' + gaugeSetting.gaugeId + '_needle3"    class="gaugeOverlay gaugeNeedle"     src="' + gaugeSetting.gauge.needleImg3    + '" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" />';
      }

      if(typeof gaugeSetting.gauge.overlayImg != "undefined") {
	gaugeHTML += 
	  '<img id="instrument' + gaugeSetting.gaugeId + '_overlay" class="gaugeOverlay gaugeForeground" src="' + gaugeSetting.gauge.overlayImg + '" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" />';
      }
	
      if(typeof gaugeSetting.gauge.foregroundImg != "undefined") {
	gaugeHTML += 
	  '<img id="instrument' + gaugeSetting.gaugeId + '_foreground" class="gaugeOverlay gaugeForeground" src="' + gaugeSetting.gauge.foregroundImg + '" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.foregroundHeight + '" />';
      }
    }
      
    gaugeHTML += 
      '<div id="gauge_' + gaugeSetting.gaugeId + 'Drag" class="gaugeDrag" width="' + gaugeSetting.gauge.width + '" height="' + gaugeSetting.gauge.height + '" />' +
      '</div>';

    if(typeof parentId === "undefined") {
      // TODO: need a better fallback than this...
      $(document.body).append(gaugeHTML);
    } else {
      $('#' + parentId).append(gaugeHTML);
    }
     
    if(typeof gaugeSetting.gauge.mask != "undefined") {
      $('#' + gaugeSetting.gaugeId).css('-webkit-mask-image', 'url(' + gaugeSetting.gauge.mask + ')');
    }
     
    panelElement = document.getElementById(gaugeSetting.gaugeId);
      
    // add the touch handler for dragging
    panelElement.addEventListener("touchstart", touchHandler, true);
    panelElement.addEventListener("touchmove", touchHandler, true);
    panelElement.addEventListener("touchend", touchHandler, true);
    panelElement.addEventListener("touchcancel", touchHandler, true);

    // todo: only set to draggable based on condition
    // set it draggable
    // test if we can use panelElement instead of searching for it again
    $("#" + gaugeSetting.gaugeId).draggable({
      grid: [5, 5],
      containment: 'parent',
      opacity: 0.50,
      snap: true,
      snapMode: 'outer',
      snapTolerance: 5,
      revert:false
    });

    // as we are creating it, set the position to top left
    
    $('#' + gaugeSetting.gaugeId).css({
	  position: 'absolute',
	  'z-index': 50,
      top : gaugeSetting.y,
      left : gaugeSetting.x
	});
  }
  
  // show the panel 
  // todo: add animation
  $('#' + gaugeSetting.gaugeId).show();
  
  return true;
}

/*
 * hideGauge() - disables a panel based on a toggle control and uses SVG for the contents
 *
 * gaugeId: the id for the gauge that is being hidden
 *
 * returns true if panel is hidden
 * 
 * Example:
 * speedEnabled = !hideGauge('speedPanel')
 */
function hideGauge(gaugeId) {
  // hide the panel for the gauge
  // todo: add animation
  $('#' + gaugeId).hide();
  
  return true;
}

// shim with requestAnimationFrame/cancelAnimationFrame - sourced from http://creativejs.com/resources/requestanimationframe/
// requestAnimationFrame polyfill by Erik Möller
// fixes from Paul Irish and Tino Zijdel

// TODO: which is better, this or the Paul Irish/Jerome Etienne Notes one?
(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame'] 
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());


// shim layer with setTimeout fallback, originally by Paul Irish
// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
/*
window.requestAnimFrame = (function(){
    return  window.requestAnimationFrame   || 
        window.webkitRequestAnimationFrame || 
        window.mozRequestAnimationFrame    || 
        window.oRequestAnimationFrame      || 
        window.msRequestAnimationFrame     || 
        function(callback, element){
            return window.setTimeout(callback, 1000 / 60);
        };
})();
*/

// shim layer for cancel, derived from Paul Irish, by Jerome Etienne Notes
/*
window.cancelRequestAnimFrame = ( function() {
    return window.cancelAnimationFrame           ||
        window.webkitCancelRequestAnimationFrame ||
        window.mozCancelRequestAnimationFrame    ||
        window.oCancelRequestAnimationFrame      ||
        window.msCancelRequestAnimationFrame     ||
        clearTimeout
} )();
*/
  
/* connection logic for websockets */

var connection = {};

function connect() {
  if(window.WebSocket != undefined) {
    if(connection.readyState === undefined || connection.readyState > 1) {
      connection = new WebSocket('ws://localhost:9007', "myProtocol");
      // connection = new WebSocket('ws://localhost:8095', 'http-only');

      connection.binaryType = "arraybuffer";
      connection.onopen = openEvent;
      connection.onmessage = messageEvent;
      connection.onclose = closeEvent;
      connection.onerror = errorEvent;
    }
  }
}

function disconnect() {
  connection.close();
}

function openEvent(event) {
  console.log(event);
  connected = true;
  // $(this).children('img').attr('src', 'assets/icons/icon_power_on.svg');
  $('#toggleConnection').children('img').attr('src', 'assets/icons/icon_power_on.svg');
}

function closeEvent(event) {
  console.log(event);
  connected = false;
  // $(this).children('img').attr('src', 'assets/icons/icon_power_off.svg');
  $('#toggleConnection').children('img').attr('src', 'assets/icons/icon_power_off.svg');
}

function messageEvent(event) {
  // var chatdiv = document.getElementById('chat');
  // chatdiv.innerHTML = chatdiv.innerHTML + event.data + "<br />";

  if(event.data instanceof ArrayBuffer) {
    console.log(event);
/*
    var bytearray = new Uint8Array(event.data);

    var tempcanvas = document.createElement('canvas');
        tempcanvas.height = imageheight;
        tempcanvas.width = imagewidth;
    var tempcontext = tempcanvas.getContext('2d');

    var imgdata = tempcontext.getImageData(0,0,imagewidth,imageheight);

    var imgdatalen = imgdata.data.length;

    for (var i=8; i < imgdatalen; i++) {
      imgdata.data[i] = bytearray[i];
    }

    tempcontext.putImageData(imgdata,0,0);

    var img = document.createElement('img');
        img.height = imageheight;
        img.width = imagewidth;
        img.src = tempcanvas.toDataURL();

    chatdiv.appendChild(img);
    chatdiv.innerHTML = chatdiv.innerHTML + '<br/>';
*/
  } else {
    console.log(event, event.data);
  }
}

function errorEvent(event) {
  console.log(event);
  // document.getElementById('chat').innerHTML = "There was an error: " + event.data;
}

function sendMessage() {
  var messageText = "blah";
  // var messageText = = document.getElementById('chatmessage').value;
  // messageText = username + ": " + messageText;
  connection.send(messageText);
}

</script>
  </head>
  <body>
    <div id="leftSidebar" class="sideBar">
      <div id="leftScroller">
        <div class="sidebarGroupHeading">
  
        </div>
        <div id="welcomeControl" class="sidebarControlBar">
          <div class="sidebarControlIcon"><img src='assets/icons/drawable-xhdpi-v11/ic_stat_compass.png' class="sidebarControlIcon"/></div>
          <div class="sidebarControlText centered">Welcome</div>
        </div>
        <div id="vehicleGroup" class="sidebarGroup">
          <div class="sidebarGroupHeading">
            <div id="vehicleGroupTitle" class="sidebarGroupTitle">Vehicles</div>
          </div>
        </div>
        <div id="serverGroup" class="sidebarGroup">
          <div class="sidebarGroupHeading">
            <div id="serversGroupTitle" class="sidebarGroupTitle">Servers</div>
          </div>
        </div>
        <div class="sidebarGroupHeading">
          <div id="preferencsGroupTitle" class="sidebarGroupTitle"></div>
        </div>
        <div id="preferencesControl" class="sidebarControlBar">
          <div class="sidebarControlIcon"><img src='assets/icons/drawable-xhdpi-v11/ic_action_settings.png' class="sidebarControlIcon"/></div>
          <div class="sidebarControlText centered">Preferences</div>
        </div>
      </div>
    </div>
    
    <div id="rightSidebar" class="sideBar rightSideBar">
      <div id="rightScroller">
        <div class="sidebarGroupHeading">
  
        </div>
        <div id="testGroup" class="sidebarGroup">
          <div class="sidebarGroupHeading">
            <div id="testGroupTitle" class="sidebarGroupTitle">Some stuff here...</div>
          </div>
        </div>
      </div>
    </div>

    <div id="mainApplication" class="mainApplication content">
      <!-- app content goes here -->
    </div>
    
  </body>
</html>
